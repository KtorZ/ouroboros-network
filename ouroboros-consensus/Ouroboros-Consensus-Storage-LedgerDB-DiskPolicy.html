<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy</p></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:DiskPolicy">DiskPolicy</a> = <a href="#v:DiskPolicy">DiskPolicy</a> {<ul class="subs"><li><a href="#v:onDiskNumSnapshots">onDiskNumSnapshots</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word" title="Data.Word">Word</a></li><li><a href="#v:onDiskShouldTakeSnapshot">onDiskShouldTakeSnapshot</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> <a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></li></ul>}</li><li class="src short"><a href="#v:defaultDiskPolicy">defaultDiskPolicy</a> &#8759; <a href="Ouroboros-Consensus-Config-SecurityParam.html#t:SecurityParam" title="Ouroboros.Consensus.Config.SecurityParam">SecurityParam</a> &#8594; <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#t:DiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">DiskPolicy</a></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:DiskPolicy" class="def">DiskPolicy</a> <a href="src/Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#DiskPolicy" class="link">Source</a> <a href="#t:DiskPolicy" class="selflink">#</a></p><div class="doc"><p>On-disk policy</p><p>We only write ledger states that are older than <code>k</code> blocks to disk (that is,
 snapshots that are guaranteed valid). The on-disk policy determines how often
 we write to disk and how many checkpoints we keep.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:DiskPolicy" class="def">DiskPolicy</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:onDiskNumSnapshots" class="def">onDiskNumSnapshots</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word" title="Data.Word">Word</a></dfn><div class="doc"><p>How many snapshots do we want to keep on disk?</p><p>A higher number of on-disk snapshots is primarily a safe-guard against
 disk corruption: it trades disk space for reliability.</p><p>Examples:</p><ul><li><code>0</code>: Delete the snapshot immediately after writing.
        Probably not a useful value :-D</li><li><code>1</code>: Delete the previous snapshot immediately after writing the next
        Dangerous policy: if for some reason the deletion happens before
        the new snapshot is written entirely to disk (we don't <code>fsync</code>),
        we have no choice but to start at the genesis snapshot on the
        next startup.</li><li><code>2</code>: Always keep 2 snapshots around. This means that when we write
        the next snapshot, we delete the oldest one, leaving the middle
        one available in case of truncation of the write. This is
        probably a sane value in most circumstances.</li></ul></div></li><li><dfn class="src"><a id="v:onDiskShouldTakeSnapshot" class="def">onDiskShouldTakeSnapshot</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> <a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></dfn><div class="doc"><p>Should we write a snapshot of the ledger state to disk?</p><p>This function is passed two bits of information:</p><ul><li>The time since the last snapshot, or <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#v:Nothing" title="GHC.Maybe">Nothing</a></code> if none was taken yet.
   Note that <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#v:Nothing" title="GHC.Maybe">Nothing</a></code> merely means no snapshot had been taking yet
   since the node was started; it does not necessarily mean that none
   exist on disk.</li><li>The distance in terms of blocks applied to the <em>oldest</em> ledger
   snapshot in memory. During normal operation, this is the number of
   blocks written to the ImmutableDB since the last snapshot. On
   startup, it is computed by counting how many immutable blocks we had
   to reapply to get to the chain tip. This is useful, as it allows the
   policy to decide to take a snapshot <em>on node startup</em> if a lot of
   blocks had to be replayed.</li></ul><p>See also <code><a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#v:defaultDiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">defaultDiskPolicy</a></code></p></div></li></ul></div></td></tr></table></div><div class="subs instances"><details id="i:DiskPolicy" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:DiskPolicy:NoUnexpectedThunks:1"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#t:DiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">DiskPolicy</a></span> <a href="src/Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#line-67" class="link">Source</a> <a href="#t:DiskPolicy" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:DiskPolicy:NoUnexpectedThunks:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html">Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:noUnexpectedThunks">noUnexpectedThunks</a> &#8759; [<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#t:DiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">DiskPolicy</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:noUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:whnfNoUnexpectedThunks">whnfNoUnexpectedThunks</a> &#8759; [<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#t:DiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">DiskPolicy</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:whnfNoUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:showTypeOf">showTypeOf</a> &#8759; <a href="Data-SOP-Strict.html#t:Proxy" title="Data.SOP.Strict">Proxy</a> <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#t:DiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">DiskPolicy</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:showTypeOf" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:defaultDiskPolicy" class="def">defaultDiskPolicy</a> &#8759; <a href="Ouroboros-Consensus-Config-SecurityParam.html#t:SecurityParam" title="Ouroboros.Consensus.Config.SecurityParam">SecurityParam</a> &#8594; <a href="Ouroboros-Consensus-Storage-LedgerDB-DiskPolicy.html#t:DiskPolicy" title="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy">DiskPolicy</a> <a href="src/Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#defaultDiskPolicy" class="link">Source</a> <a href="#v:defaultDiskPolicy" class="selflink">#</a></p><div class="doc"><p>Default on-disk policy</p><p>We want to take a snapshot every 50k blocks or roughly every hour (72
 minutes actually) when <code>k = 2160</code> (for other values of <code>k</code> we scale
 proportionally), but not more rapidly than 10 per hour (which is important
 for bulk sync).</p><p>If users never leave their wallet running for long, however, this would mean
 that we <em>never</em> take snapshots after syncing (until we get to 50k blocks).
 So, on startup, we take a snapshot as soon as there are <code>k</code> blocks replayed.
 This means that even if users frequently shut down their wallet, we still
 take a snapshot roughly every <code>k</code> blocks. It does mean the possibility of
 an extra unnecessary snapshot during syncing (if the node is restarted), but
 that is not a big deal.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>