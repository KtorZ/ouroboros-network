<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds           #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass            #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric             #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts          #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE GADTs                     #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase                #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf                #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns            #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings         #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints     #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards           #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables       #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE TupleSections             #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications          #-}</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- | Volatile on-disk database of blocks</span><span>
</span><a name="line-18"></a><span class="hs-comment">--</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- = Logic</span><span>
</span><a name="line-20"></a><span class="hs-comment">--</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- The VolatileDB is a key-value store of blocks indexed by their hashes. It is</span><span>
</span><a name="line-22"></a><span class="hs-comment">-- parameterised by the block type @blk@.</span><span>
</span><a name="line-23"></a><span class="hs-comment">--</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- The \&quot;volatile\&quot; in the name refers to the fact that the blocks stored in it</span><span>
</span><a name="line-25"></a><span class="hs-comment">-- make up the /volatile/ part of the chain, i.e., the last @k@ blocks of the</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- chain, which can still be rolled back. Not only the last @k@ blocks of the</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- current chain are stored in this database, but also blocks of forks which we</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- have switched from or will switch to.</span><span>
</span><a name="line-29"></a><span class="hs-comment">--</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- The VolatileDB appends new blocks sequentially to a file. When</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- 'volMaxBlocksPerFile' are stored in the current file, a new file is started.</span><span>
</span><a name="line-32"></a><span class="hs-comment">--</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- The VolatileDB provides four main operations:</span><span>
</span><a name="line-34"></a><span class="hs-comment">--</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- 1. Adding blocks with 'putBlock'</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- 2. Get blocks or information about them with 'getBlockComponent'</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- 3. Accessing the in-memory indices using 'getBlockInfo' and</span><span>
</span><a name="line-38"></a><span class="hs-comment">--   'filterByPredecessor'</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- 4. Garbage collecting blocks older than a given slot using 'garbageCollect'</span><span>
</span><a name="line-40"></a><span class="hs-comment">--</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- Garbage collection will only delete a file from the VolatileDB when all</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- blocks in it have a slot older than the one passed to 'garbageCollect'.</span><span>
</span><a name="line-43"></a><span class="hs-comment">--</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- = Errors</span><span>
</span><a name="line-45"></a><span class="hs-comment">--</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- When an exception occurs while modifying the VolatileDB, we close the</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- database as a safety measure, e.g., in case a file could not be written to</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- disk, as we can no longer make sure the in-memory indices match what's stored</span><span>
</span><a name="line-49"></a><span class="hs-comment">-- on the file system. When reopening, we validate the blocks stored in the file</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- system and reconstruct the in-memory indices.</span><span>
</span><a name="line-51"></a><span class="hs-comment">--</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- NOTE: this means that when a thread modifying the VolatileDB is killed, the</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- database will be closed. This is an intentional choice to simplify things.</span><span>
</span><a name="line-54"></a><span class="hs-comment">--</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- The in-memory indices can always be reconstructed from the file system.</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- This is important, as we must be resilient against unexpected shutdowns,</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- power losses, etc.</span><span>
</span><a name="line-58"></a><span class="hs-comment">--</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- We achieve this by only performing basic operations on the VolatileDB:</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- * 'putBlock' only appends a new block to a file. Losing an update means we</span><span>
</span><a name="line-61"></a><span class="hs-comment">--   only lose a block, which is not a problem, it can be redownloaded.</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- * 'garbageCollect' only deletes entire files.</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- * There is no operation that modifies a file in-place. This means we do not</span><span>
</span><a name="line-64"></a><span class="hs-comment">--   have to keep any rollback journals to make sure we are safe in case of</span><span>
</span><a name="line-65"></a><span class="hs-comment">--   unexpected shutdowns.</span><span>
</span><a name="line-66"></a><span class="hs-comment">--</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- We only throw 'VolatileDBError'. File-system errors are caught, wrapped in a</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- 'VolatileDBError', and rethrown. We make sure that all calls to 'HasFS'</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- functions are properly wrapped. This wrapping is automatically done when</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- inside the scope of 'modifyOpenState' and 'withOpenState'. Otherwise, we use</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- 'wrapFsError'.</span><span>
</span><a name="line-72"></a><span class="hs-comment">--</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- = Concurrency</span><span>
</span><a name="line-74"></a><span class="hs-comment">--</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- A single folder should only be used by a single VolatileDB. Naturally, a</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- VolatileDB can be accessed concurrently by multiple threads.</span><span>
</span><a name="line-77"></a><span class="hs-comment">--</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- = File-system layout:</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- The on-disk representation is as follows:</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- &gt; dbFolder/</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- &gt;   blocks-0.dat</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- &gt;   blocks-1.dat</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- &gt;   ...</span><span>
</span><a name="line-86"></a><span class="hs-comment">--</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- Files not fitting the naming scheme are ignored. The numbering of these</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- files does not correlate to the blocks stored in them.</span><span>
</span><a name="line-89"></a><span class="hs-comment">--</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- Each file stores a fixed number of blocks, specified by</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- 'volMaxBlocksPerFile'. When opening the VolatileDB, it will start appending</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- to the file with the highest number that is not yet full. If all are full or</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- none exist, a new file will be created.</span><span>
</span><a name="line-94"></a><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- There is an implicit ordering of block files, which is NOT alpharithmetic.</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- For example, @blocks-20.dat@ &lt; @blocks-100.dat@.</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- = Recovery</span><span>
</span><a name="line-99"></a><span class="hs-comment">--</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- The VolatileDB will always try to recover to a consistent state even if this</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- means deleting all of its contents. In order to achieve this, it truncates</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- the files containing blocks if some blocks fail to parse, are invalid, or are</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- duplicated.</span><span>
</span><a name="line-104"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-comment">-- * Opening the database</span><span>
</span><a name="line-106"></a><span>    </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB"><span class="hs-identifier hs-var">openDB</span></a><span>
</span><a name="line-107"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#defaultArgs"><span class="hs-identifier hs-var">defaultArgs</span></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier hs-type">VolatileDbSerialiseConstraints</span></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-comment">-- * Re-exported</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlocksPerFile"><span class="hs-identifier hs-type">BlocksPerFile</span></a><span>
</span><a name="line-112"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#mkBlocksPerFile"><span class="hs-identifier hs-var">mkBlocksPerFile</span></a><span>
</span><a name="line-113"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockValidationPolicy"><span class="hs-identifier hs-type">BlockValidationPolicy</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ParseError"><span class="hs-identifier hs-type">ParseError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser.html#extractBlockInfo"><span class="hs-identifier hs-var">extractBlockInfo</span></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Codec.CBOR.Read</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CBOR</span><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Codec.CBOR.Write</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CBOR</span><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.State.Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">get</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gets</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lift</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">modify</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">put</span><span class="hs-special">,</span><span>
</span><a name="line-123"></a><span>                     </span><span class="hs-identifier hs-var">state</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html"><span class="hs-identifier">Control.Tracer</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#nullTracer"><span class="hs-identifier hs-var">nullTracer</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Lazy</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Functor.Identity</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Identity</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Stack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.FilePath</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;/&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html"><span class="hs-identifier">Ouroboros.Network.Block</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.Args.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Args</span></a><span>
</span><a name="line-140"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a><span>
</span><a name="line-141"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html"><span class="hs-identifier">Ouroboros.Consensus.Util.MonadSTM.RAWLock</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">RAWLock</span><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var">allocateTemp</span></a><span class="hs-special">,</span><span>
</span><a name="line-143"></a><span>                     </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-var">runWithTempRegistry</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.Common.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Common</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.FS.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API</span></a><span>
</span><a name="line-147"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API.Types</span></a><span>
</span><a name="line-148"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.FS.IO.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.IO</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.IO.html#ioHasFS"><span class="hs-identifier hs-var">ioHasFS</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.Serialisation.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.API</span></a><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">FileInfo</span><span>
</span><a name="line-154"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Index</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Index</span><span>
</span><a name="line-155"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser</span></a><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.State</span></a><span>
</span><a name="line-157"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Types</span></a><span>
</span><a name="line-158"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Util</span></a><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">{------------------------------------------------------------------------------
  Opening the database
------------------------------------------------------------------------------}</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-keyword">data</span><span> </span><a name="VolatileDbArgs"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier">VolatileDbArgs</span></a></a><span> </span><a name="local-6989586621679469400"><a href="#local-6989586621679469400"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679469401"><a href="#local-6989586621679469401"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469402"><a href="#local-6989586621679469402"><span class="hs-identifier">blk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="VolatileDbArgs"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier">VolatileDbArgs</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-165"></a><span>      </span><a name="volCheckIntegrity"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volCheckIntegrity"><span class="hs-identifier">volCheckIntegrity</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a><span> </span><a href="#local-6989586621679469400"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">blk</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="volCodecConfig"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volCodecConfig"><span class="hs-identifier">volCodecConfig</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a><span> </span><a href="#local-6989586621679469400"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Block.Abstract.html#CodecConfig"><span class="hs-identifier hs-type">CodecConfig</span></a><span> </span><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="volHasFS"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volHasFS"><span class="hs-identifier">volHasFS</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-type">SomeHasFS</span></a><span> </span><a href="#local-6989586621679469401"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-168"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="volMaxBlocksPerFile"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volMaxBlocksPerFile"><span class="hs-identifier">volMaxBlocksPerFile</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlocksPerFile"><span class="hs-identifier hs-type">BlocksPerFile</span></a><span>
</span><a name="line-169"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="volTracer"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volTracer"><span class="hs-identifier">volTracer</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679469401"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a><span> </span><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="volValidationPolicy"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volValidationPolicy"><span class="hs-identifier">volValidationPolicy</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockValidationPolicy"><span class="hs-identifier hs-type">BlockValidationPolicy</span></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">-- | Default arguments when using the 'IO' monad</span><span>
</span><a name="line-174"></a><span class="hs-identifier">defaultArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a><span> </span><a href="Ouroboros.Consensus.Util.Args.html#Defaults"><span class="hs-identifier hs-type">Defaults</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679469430"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-175"></a><a name="defaultArgs"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#defaultArgs"><span class="hs-identifier">defaultArgs</span></a></a><span> </span><a name="local-6989586621679469431"><a href="#local-6989586621679469431"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-var">VolatileDbArgs</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-176"></a><span>      </span><span class="hs-identifier">volCheckIntegrity</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">volCodecConfig</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">volHasFS</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-var">SomeHasFS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.IO.html#ioHasFS"><span class="hs-identifier hs-var">ioHasFS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#MountPoint"><span class="hs-identifier hs-var">MountPoint</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679469431"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;volatile&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">volMaxBlocksPerFile</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#mkBlocksPerFile"><span class="hs-identifier hs-var">mkBlocksPerFile</span></a><span> </span><span class="hs-number">1000</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">volTracer</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#nullTracer"><span class="hs-identifier hs-var">nullTracer</span></a><span>
</span><a name="line-181"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">volValidationPolicy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#NoValidation"><span class="hs-identifier hs-var">NoValidation</span></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-comment">-- | 'EncodeDisk' and 'DecodeDisk' constraints needed for the VolatileDB.</span><span>
</span><a name="line-185"></a><span class="hs-keyword">type</span><span> </span><a name="VolatileDbSerialiseConstraints"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier">VolatileDbSerialiseConstraints</span></a></a><span> </span><a name="local-6989586621679469399"><a href="#local-6989586621679469399"><span class="hs-identifier">blk</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-186"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#EncodeDisk"><span class="hs-identifier hs-type">EncodeDisk</span></a><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-187"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Lazy.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Block.NestedContent.html#HasNestedContent"><span class="hs-identifier hs-type">HasNestedContent</span></a><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a><span> </span><a href="#local-6989586621679469399"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-191"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">openDB</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-194"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469428"><a href="#local-6989586621679469428"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469429"><a href="#local-6989586621679469429"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-195"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span>
</span><a name="line-196"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469428"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-197"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469429"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-198"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a><span> </span><a href="#local-6989586621679469429"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-199"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier hs-type">VolatileDbSerialiseConstraints</span></a><span> </span><a href="#local-6989586621679469429"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-200"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a><span> </span><span class="hs-identifier hs-type">Identity</span><span> </span><a href="#local-6989586621679469428"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469429"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469428"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a><span> </span><a href="#local-6989586621679469428"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469429"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><a name="openDB"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB"><span class="hs-identifier">openDB</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-var">VolatileDbArgs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">volHasFS</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-var">SomeHasFS</span></a><span> </span><a name="local-6989586621679469432"><a href="#local-6989586621679469432"><span class="hs-identifier">hasFS</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-var">runWithTempRegistry</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">createDirectoryIfMissing</span><span> </span><a href="#local-6989586621679469432"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#mkFsPath"><span class="hs-identifier hs-var">mkFsPath</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>    </span><a name="local-6989586621679469438"><a href="#local-6989586621679469438"><span class="hs-identifier">ost</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-206"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a><span>
</span><a name="line-207"></a><span>        </span><a href="#local-6989586621679469434"><span class="hs-identifier hs-var">volCodecConfig</span></a><span>
</span><a name="line-208"></a><span>        </span><a href="#local-6989586621679469432"><span class="hs-identifier hs-var">hasFS</span></a><span>
</span><a name="line-209"></a><span>        </span><a href="#local-6989586621679469433"><span class="hs-identifier hs-var">volCheckIntegrity</span></a><span>
</span><a name="line-210"></a><span>        </span><a href="#local-6989586621679469437"><span class="hs-identifier hs-var">volValidationPolicy</span></a><span>
</span><a name="line-211"></a><span>        </span><a href="#local-6989586621679469436"><span class="hs-identifier hs-var">volTracer</span></a><span>
</span><a name="line-212"></a><span>        </span><a href="#local-6989586621679469435"><span class="hs-identifier hs-var">volMaxBlocksPerFile</span></a><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621679469439"><a href="#local-6989586621679469439"><span class="hs-identifier">stVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html#new"><span class="hs-identifier hs-var">RAWLock.new</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a href="#local-6989586621679469438"><span class="hs-identifier hs-var">ost</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679469440"><a href="#local-6989586621679469440"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-var">VolatileDBEnv</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-215"></a><span>            </span><span class="hs-identifier">hasFS</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469432"><span class="hs-identifier hs-var">hasFS</span></a><span>
</span><a name="line-216"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">varInternalState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469439"><span class="hs-identifier hs-var">stVar</span></a><span>
</span><a name="line-217"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxBlocksPerFile</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469435"><span class="hs-identifier hs-var">volMaxBlocksPerFile</span></a><span>
</span><a name="line-218"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tracer</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469436"><span class="hs-identifier hs-var">volTracer</span></a><span>
</span><a name="line-219"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">codecConfig</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469434"><span class="hs-identifier hs-var">volCodecConfig</span></a><span>
</span><a name="line-220"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">checkIntegrity</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469433"><span class="hs-identifier hs-var">volCheckIntegrity</span></a><span>
</span><a name="line-221"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-222"></a><span>        </span><a name="local-6989586621679469441"><a href="#local-6989586621679469441"><span class="hs-identifier">volatileDB</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-var">VolatileDB</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-223"></a><span>            </span><span class="hs-identifier">closeDB</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-var">closeDBImpl</span></a><span>             </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-224"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getBlockComponent</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-var">getBlockComponentImpl</span></a><span>   </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-225"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">putBlock</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#putBlockImpl"><span class="hs-identifier hs-var">putBlockImpl</span></a><span>            </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-226"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">garbageCollect</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectImpl"><span class="hs-identifier hs-var">garbageCollectImpl</span></a><span>      </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-227"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">filterByPredecessor</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#filterByPredecessorImpl"><span class="hs-identifier hs-var">filterByPredecessorImpl</span></a><span> </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-228"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getBlockInfo</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockInfoImpl"><span class="hs-identifier hs-var">getBlockInfoImpl</span></a><span>        </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-229"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getMaxSlotNo</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getMaxSlotNoImpl"><span class="hs-identifier hs-var">getMaxSlotNoImpl</span></a><span>        </span><a href="#local-6989586621679469440"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-230"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-231"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679469441"><span class="hs-identifier hs-var">volatileDB</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679469438"><span class="hs-identifier hs-var">ost</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-comment">{------------------------------------------------------------------------------
  VolatileDB API
------------------------------------------------------------------------------}</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-identifier">closeDBImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469426"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469426"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469427"><span class="hs-identifier hs-type">blk</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469426"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><a name="closeDBImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#closeDBImpl"><span class="hs-identifier">closeDBImpl</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-var">VolatileDBEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469442"><a href="#local-6989586621679469442"><span class="hs-identifier">varInternalState</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469443"><a href="#local-6989586621679469443"><span class="hs-identifier">tracer</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469444"><a href="#local-6989586621679469444"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621679469446"><a href="#local-6989586621679469446"><span class="hs-identifier">mbInternalState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-240"></a><span>      </span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html#withWriteAccess"><span class="hs-identifier hs-var">RAWLock.withWriteAccess</span></a><span> </span><a href="#local-6989586621679469442"><span class="hs-identifier hs-var">varInternalState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469445"><a href="#local-6989586621679469445"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679469445"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679469446"><span class="hs-identifier hs-var">mbInternalState</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-242"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679469443"><span class="hs-identifier hs-var">tracer</span></a><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#DBAlreadyClosed"><span class="hs-identifier hs-var">DBAlreadyClosed</span></a><span>
</span><a name="line-243"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a name="local-6989586621679469447"><a href="#local-6989586621679469447"><span class="hs-identifier">ost</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-244"></a><span>        </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#wrapFsError"><span class="hs-identifier hs-var">wrapFsError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#closeOpenHandles"><span class="hs-identifier hs-var">closeOpenHandles</span></a><span> </span><a href="#local-6989586621679469444"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469447"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">getBlockComponentImpl</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-247"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469423"><a href="#local-6989586621679469423"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469424"><a href="#local-6989586621679469424"><span class="hs-identifier">blk</span></a></a><span> </span><a name="local-6989586621679469425"><a href="#local-6989586621679469425"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-248"></a><span>     </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-249"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-250"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Lazy.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Block.NestedContent.html#HasNestedContent"><span class="hs-identifier hs-type">HasNestedContent</span></a><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-252"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-253"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span>
</span><a name="line-254"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469425"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-257"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679469425"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><a name="getBlockComponentImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier">getBlockComponentImpl</span></a></a><span> </span><a name="local-6989586621679469448"><a href="#local-6989586621679469448"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-var">VolatileDBEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469449"><a href="#local-6989586621679469449"><span class="hs-identifier">codecConfig</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469450"><a href="#local-6989586621679469450"><span class="hs-identifier">checkIntegrity</span></a></a><span> </span><span class="hs-special">}</span><span> </span><a name="local-6989586621679469451"><a href="#local-6989586621679469451"><span class="hs-identifier">blockComponent</span></a></a><span> </span><a name="local-6989586621679469452"><a href="#local-6989586621679469452"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-260"></a><span>    </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#withOpenState"><span class="hs-identifier hs-var">withOpenState</span></a><span> </span><a href="#local-6989586621679469448"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469492"><a href="#local-6989586621679469492"><span class="hs-identifier">hasFS</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469493"><a href="#local-6989586621679469493"><span class="hs-identifier">currentRevMap</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-261"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679469452"><span class="hs-identifier hs-var">hash</span></a><span> </span><a href="#local-6989586621679469493"><span class="hs-identifier hs-var">currentRevMap</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-262"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-263"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679469494"><a href="#local-6989586621679469494"><span class="hs-identifier">internalBlockInfo</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-264"></a><span>          </span><a href="#local-6989586621679469453"><span class="hs-identifier hs-var">getBlockComponent</span></a><span> </span><a href="#local-6989586621679469492"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469494"><span class="hs-identifier hs-var">internalBlockInfo</span></a><span> </span><a href="#local-6989586621679469451"><span class="hs-identifier hs-var">blockComponent</span></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-identifier">getBlockComponent</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-267"></a><span>         </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469454"><a href="#local-6989586621679469454"><span class="hs-identifier">b'</span></a></a><span> </span><a name="local-6989586621679469455"><a href="#local-6989586621679469455"><span class="hs-identifier">h</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469455"><span class="hs-identifier hs-type">h</span></a><span>
</span><a name="line-268"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#InternalBlockInfo"><span class="hs-identifier hs-type">InternalBlockInfo</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-269"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469454"><span class="hs-identifier hs-type">b'</span></a><span>
</span><a name="line-270"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469454"><span class="hs-identifier hs-type">b'</span></a><span>
</span><a name="line-271"></a><span>    </span><a name="local-6989586621679469453"><a href="#local-6989586621679469453"><span class="hs-identifier">getBlockComponent</span></a></a><span> </span><a name="local-6989586621679469456"><a href="#local-6989586621679469456"><span class="hs-identifier">hasFS</span></a></a><span> </span><a name="local-6989586621679469457"><a href="#local-6989586621679469457"><span class="hs-identifier">ibi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-272"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetHash"><span class="hs-identifier hs-var">GetHash</span></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469452"><span class="hs-identifier hs-var">hash</span></a><span>
</span><a name="line-273"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetSlot"><span class="hs-identifier hs-var">GetSlot</span></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469459"><span class="hs-identifier hs-var">biSlotNo</span></a><span>
</span><a name="line-274"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetIsEBB"><span class="hs-identifier hs-var">GetIsEBB</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469462"><span class="hs-identifier hs-var">biIsEBB</span></a><span>
</span><a name="line-275"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlockSize"><span class="hs-identifier hs-var">GetBlockSize</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unBlockSize</span><span> </span><a href="#local-6989586621679469467"><span class="hs-identifier hs-var">ibiBlockSize</span></a><span>
</span><a name="line-276"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeaderSize"><span class="hs-identifier hs-var">GetHeaderSize</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469464"><span class="hs-identifier hs-var">biHeaderSize</span></a><span>
</span><a name="line-277"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetPure"><span class="hs-identifier hs-var">GetPure</span></a><span> </span><a name="local-6989586621679469482"><a href="#local-6989586621679469482"><span class="hs-identifier">a</span></a></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469482"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-278"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetApply"><span class="hs-identifier hs-var">GetApply</span></a><span> </span><a name="local-6989586621679469483"><a href="#local-6989586621679469483"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679469484"><a href="#local-6989586621679469484"><span class="hs-identifier">bc</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-279"></a><span>          </span><a href="#local-6989586621679469453"><span class="hs-identifier hs-var">getBlockComponent</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469457"><span class="hs-identifier hs-var">ibi</span></a><span> </span><a href="#local-6989586621679469483"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679469453"><span class="hs-identifier hs-var">getBlockComponent</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469457"><span class="hs-identifier hs-var">ibi</span></a><span> </span><a href="#local-6989586621679469484"><span class="hs-identifier hs-var">bc</span></a><span>
</span><a name="line-280"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlock"><span class="hs-identifier hs-var">GetBlock</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-281"></a><span>          </span><a href="#local-6989586621679469453"><span class="hs-identifier hs-var">getBlockComponent</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469457"><span class="hs-identifier hs-var">ibi</span></a><span> </span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawBlock"><span class="hs-identifier hs-var">GetRawBlock</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679469469"><span class="hs-identifier hs-var">parseBlock</span></a><span>
</span><a name="line-282"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawBlock"><span class="hs-identifier hs-var">GetRawBlock</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#withFile"><span class="hs-identifier hs-var">withFile</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469465"><span class="hs-identifier hs-var">ibiFile</span></a><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#ReadMode"><span class="hs-identifier hs-var">ReadMode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469485"><a href="#local-6989586621679469485"><span class="hs-identifier">hndl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-283"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679469486"><a href="#local-6989586621679469486"><span class="hs-identifier">size</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unBlockSize</span><span> </span><a href="#local-6989586621679469467"><span class="hs-identifier hs-var">ibiBlockSize</span></a><span>
</span><a name="line-284"></a><span>              </span><a name="local-6989586621679469487"><a href="#local-6989586621679469487"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unBlockOffset</span><span> </span><a href="#local-6989586621679469466"><span class="hs-identifier hs-var">ibiBlockOffset</span></a><span>
</span><a name="line-285"></a><span>          </span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactlyAt"><span class="hs-identifier hs-var">hGetExactlyAt</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469485"><span class="hs-identifier hs-var">hndl</span></a><span> </span><a href="#local-6989586621679469486"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-var">AbsOffset</span></a><span> </span><a href="#local-6989586621679469487"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeader"><span class="hs-identifier hs-var">GetHeader</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-287"></a><span>          </span><a href="#local-6989586621679469453"><span class="hs-identifier hs-var">getBlockComponent</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469457"><span class="hs-identifier hs-var">ibi</span></a><span> </span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawHeader"><span class="hs-identifier hs-var">GetRawHeader</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679469470"><span class="hs-identifier hs-var">parseHeader</span></a><span>
</span><a name="line-288"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawHeader"><span class="hs-identifier hs-var">GetRawHeader</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#withFile"><span class="hs-identifier hs-var">withFile</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469465"><span class="hs-identifier hs-var">ibiFile</span></a><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#ReadMode"><span class="hs-identifier hs-var">ReadMode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469488"><a href="#local-6989586621679469488"><span class="hs-identifier">hndl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679469489"><a href="#local-6989586621679469489"><span class="hs-identifier">size</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679469464"><span class="hs-identifier hs-var">biHeaderSize</span></a><span>
</span><a name="line-290"></a><span>              </span><a name="local-6989586621679469490"><a href="#local-6989586621679469490"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unBlockOffset</span><span> </span><a href="#local-6989586621679469466"><span class="hs-identifier hs-var">ibiBlockOffset</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679469463"><span class="hs-identifier hs-var">biHeaderOffset</span></a><span>
</span><a name="line-291"></a><span>          </span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactlyAt"><span class="hs-identifier hs-var">hGetExactlyAt</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469488"><span class="hs-identifier hs-var">hndl</span></a><span> </span><a href="#local-6989586621679469489"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-var">AbsOffset</span></a><span> </span><a href="#local-6989586621679469490"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetNestedCtxt"><span class="hs-identifier hs-var">GetNestedCtxt</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469468"><span class="hs-identifier hs-var">ibiNestedCtxt</span></a><span>
</span><a name="line-293"></a><span>        </span><a href="Ouroboros.Consensus.Storage.Common.html#GetVerifiedBlock"><span class="hs-identifier hs-var">GetVerifiedBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-294"></a><span>          </span><a href="#local-6989586621679469453"><span class="hs-identifier hs-var">getBlockComponent</span></a><span> </span><a href="#local-6989586621679469456"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469457"><span class="hs-identifier hs-var">ibi</span></a><span> </span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlock"><span class="hs-identifier hs-var">GetBlock</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469491"><a href="#local-6989586621679469491"><span class="hs-identifier">blk</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-295"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679469450"><span class="hs-identifier hs-var">checkIntegrity</span></a><span> </span><a href="#local-6989586621679469491"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-296"></a><span>              </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-var">UnexpectedFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#CorruptBlockError"><span class="hs-identifier hs-var">CorruptBlockError</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679469452"><span class="hs-identifier hs-var">hash</span></a><span>
</span><a name="line-297"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679469491"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-298"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-299"></a><span>        </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#InternalBlockInfo"><span class="hs-identifier hs-var">InternalBlockInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ibiBlockInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#BlockInfo"><span class="hs-identifier hs-var">BlockInfo</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469457"><span class="hs-identifier hs-var">ibi</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>        </span><span class="hs-identifier">parseBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Lazy.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-302"></a><span>        </span><a name="local-6989586621679469469"><a href="#local-6989586621679469469"><span class="hs-identifier">parseBlock</span></a></a><span> </span><a name="local-6989586621679469474"><a href="#local-6989586621679469474"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469472"><span class="hs-identifier hs-var">throwParseErrors</span></a><span> </span><a href="#local-6989586621679469474"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-303"></a><span>            </span><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#decodeDisk"><span class="hs-identifier hs-var">decodeDisk</span></a><span> </span><a href="#local-6989586621679469449"><span class="hs-identifier hs-var">codecConfig</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679469474"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span>        </span><span class="hs-identifier">parseHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Lazy.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>        </span><a name="local-6989586621679469470"><a href="#local-6989586621679469470"><span class="hs-identifier">parseHeader</span></a></a><span> </span><a name="local-6989586621679469475"><a href="#local-6989586621679469475"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469472"><span class="hs-identifier hs-var">throwParseErrors</span></a><span> </span><a href="#local-6989586621679469475"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-307"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679469468"><span class="hs-identifier hs-var">ibiNestedCtxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-308"></a><span>              </span><a href="Ouroboros.Consensus.Block.Abstract.html#SomeBlock"><span class="hs-identifier hs-var">SomeBlock</span></a><span> </span><a name="local-6989586621679469476"><a href="#local-6989586621679469476"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-309"></a><span>                </span><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span><span>
</span><a name="line-310"></a><span>                  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679469477"><a href="#local-6989586621679469477"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Block.NestedContent.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.Util.DepPair.html#DepPair"><span class="hs-identifier hs-var">DepPair</span></a><span> </span><a href="#local-6989586621679469476"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679469477"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-311"></a><span>                      </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#decodeDiskDep"><span class="hs-identifier hs-var">decodeDiskDep</span></a><span> </span><a href="#local-6989586621679469449"><span class="hs-identifier hs-var">codecConfig</span></a><span> </span><a href="#local-6989586621679469476"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>                  </span><a href="#local-6989586621679469475"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span>        </span><span class="hs-identifier">pt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a><span> </span><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-315"></a><span>        </span><a name="local-6989586621679469471"><a href="#local-6989586621679469471"><span class="hs-identifier">pt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-var">RealPoint</span></a><span> </span><a href="#local-6989586621679469459"><span class="hs-identifier hs-var">biSlotNo</span></a><span> </span><a href="#local-6989586621679469452"><span class="hs-identifier hs-var">hash</span></a><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>        </span><span class="hs-identifier">throwParseErrors</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-318"></a><span>             </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469473"><a href="#local-6989586621679469473"><span class="hs-identifier">b''</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-319"></a><span>             </span><span class="hs-identifier hs-type">Lazy.ByteString</span><span>
</span><a name="line-320"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">CBOR.DeserialiseFailure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Lazy.ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Lazy.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469473"><span class="hs-identifier hs-type">b''</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469423"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469473"><span class="hs-identifier hs-type">b''</span></a><span>
</span><a name="line-322"></a><span>        </span><a name="local-6989586621679469472"><a href="#local-6989586621679469472"><span class="hs-identifier">throwParseErrors</span></a></a><span> </span><a name="local-6989586621679469478"><a href="#local-6989586621679469478"><span class="hs-identifier">fullBytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-323"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679469479"><a href="#local-6989586621679469479"><span class="hs-identifier">trailing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469480"><a href="#local-6989586621679469480"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Lazy.null</span><span> </span><a href="#local-6989586621679469479"><span class="hs-identifier hs-var">trailing</span></a><span>
</span><a name="line-325"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679469480"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679469478"><span class="hs-identifier hs-var">fullBytes</span></a><span>
</span><a name="line-326"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-327"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-var">UnexpectedFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#TrailingDataError"><span class="hs-identifier hs-var">TrailingDataError</span></a><span> </span><a href="#local-6989586621679469465"><span class="hs-identifier hs-var">ibiFile</span></a><span> </span><a href="#local-6989586621679469471"><span class="hs-identifier hs-var">pt</span></a><span> </span><a href="#local-6989586621679469479"><span class="hs-identifier hs-var">trailing</span></a><span>
</span><a name="line-328"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679469481"><a href="#local-6989586621679469481"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-329"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-var">UnexpectedFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a><span> </span><a href="#local-6989586621679469465"><span class="hs-identifier hs-var">ibiFile</span></a><span> </span><a href="#local-6989586621679469471"><span class="hs-identifier hs-var">pt</span></a><span> </span><a href="#local-6989586621679469481"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-comment">-- | This function follows the approach:</span><span>
</span><a name="line-332"></a><span class="hs-comment">-- (1) hPut bytes to the file</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- (2) if full hClose the write file</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- (3)         hOpen a new write file</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- (4) update the Internal State.</span><span>
</span><a name="line-336"></a><span class="hs-comment">--</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- If there is an error after (1) or after (2) we should make sure that when</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- we reopen a db from scratch, it can successfully recover, even if it does</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- not find an empty file to write and all other files are full.</span><span>
</span><a name="line-340"></a><span class="hs-comment">--</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- We should also make sure that the db can recover if we get an</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- exception/error at any moment and that we are left with an empty Internal</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- State.</span><span>
</span><a name="line-344"></a><span class="hs-comment">--</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- We should be careful about not leaking open fds when we open a new file,</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- since this can affect garbage collection of files.</span><span>
</span><a name="line-347"></a><span class="hs-identifier">putBlockImpl</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-348"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469421"><a href="#local-6989586621679469421"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469422"><a href="#local-6989586621679469422"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-349"></a><span>     </span><span class="hs-special">(</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-350"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-351"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#EncodeDisk"><span class="hs-identifier hs-type">EncodeDisk</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-352"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-353"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Block.NestedContent.html#HasNestedContent"><span class="hs-identifier hs-type">HasNestedContent</span></a><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-354"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469421"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-355"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469421"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469421"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-359"></a><a name="putBlockImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#putBlockImpl"><span class="hs-identifier">putBlockImpl</span></a></a><span> </span><a name="local-6989586621679469495"><a href="#local-6989586621679469495"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-var">VolatileDBEnv</span></a><span class="hs-special">{</span><span> </span><a name="local-6989586621679469496"><a href="#local-6989586621679469496"><span class="hs-identifier">maxBlocksPerFile</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469497"><a href="#local-6989586621679469497"><span class="hs-identifier">tracer</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469498"><a href="#local-6989586621679469498"><span class="hs-identifier">codecConfig</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-360"></a><span>             </span><a name="local-6989586621679469499"><a href="#local-6989586621679469499"><span class="hs-identifier">blk</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-361"></a><span>    </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#appendOpenState"><span class="hs-identifier hs-var">appendOpenState</span></a><span> </span><a href="#local-6989586621679469495"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469523"><a href="#local-6989586621679469523"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-362"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469524"><a href="#local-6989586621679469524"><span class="hs-identifier">currentRevMap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469525"><a href="#local-6989586621679469525"><span class="hs-identifier">currentWriteHandle</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-363"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">Map.member</span><span> </span><a href="#local-6989586621679469501"><span class="hs-identifier hs-var">biHash</span></a><span> </span><a href="#local-6989586621679469524"><span class="hs-identifier hs-var">currentRevMap</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-364"></a><span>        </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679469497"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockAlreadyHere"><span class="hs-identifier hs-var">BlockAlreadyHere</span></a><span> </span><a href="#local-6989586621679469501"><span class="hs-identifier hs-var">biHash</span></a><span>
</span><a name="line-365"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-366"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679469526"><a href="#local-6989586621679469526"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CBOR.toLazyByteString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.Serialisation.html#encodeDisk"><span class="hs-identifier hs-var">encodeDisk</span></a><span> </span><a href="#local-6989586621679469498"><span class="hs-identifier hs-var">codecConfig</span></a><span> </span><a href="#local-6989586621679469499"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-367"></a><span>        </span><a name="local-6989586621679469527"><a href="#local-6989586621679469527"><span class="hs-identifier">bytesWritten</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAll"><span class="hs-identifier hs-var">hPutAll</span></a><span> </span><a href="#local-6989586621679469523"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469525"><span class="hs-identifier hs-var">currentWriteHandle</span></a><span> </span><a href="#local-6989586621679469526"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-368"></a><span>        </span><a name="local-6989586621679469528"><a href="#local-6989586621679469528"><span class="hs-identifier">fileIsFull</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">state</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679469504"><span class="hs-identifier hs-var">updateStateAfterWrite</span></a><span> </span><a href="#local-6989586621679469527"><span class="hs-identifier hs-var">bytesWritten</span></a><span>
</span><a name="line-369"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679469528"><span class="hs-identifier hs-var">fileIsFull</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#nextFile"><span class="hs-identifier hs-var">nextFile</span></a><span> </span><a href="#local-6989586621679469523"><span class="hs-identifier hs-var">hasFS</span></a><span>
</span><a name="line-370"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-371"></a><span>    </span><a name="local-6989586621679469500"><a href="#local-6989586621679469500"><span class="hs-identifier">blockInfo</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#BlockInfo"><span class="hs-identifier hs-var">BlockInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469501"><a href="#local-6989586621679469501"><span class="hs-identifier">biHash</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469502"><a href="#local-6989586621679469502"><span class="hs-identifier">biSlotNo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469503"><a href="#local-6989586621679469503"><span class="hs-identifier">biPrevHash</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser.html#extractBlockInfo"><span class="hs-identifier hs-var">extractBlockInfo</span></a><span> </span><a href="#local-6989586621679469499"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>    </span><span class="hs-identifier">updateStateAfterWrite</span><span>
</span><a name="line-374"></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469505"><a href="#local-6989586621679469505"><span class="hs-identifier">h</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-375"></a><span>         </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-376"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469505"><span class="hs-identifier hs-type">h</span></a><span>
</span><a name="line-377"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679469422"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469505"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ True: current file is full</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621679469504"><a href="#local-6989586621679469504"><span class="hs-identifier">updateStateAfterWrite</span></a></a><span> </span><a name="local-6989586621679469506"><a href="#local-6989586621679469506"><span class="hs-identifier">bytesWritten</span></a></a><span> </span><a name="local-6989586621679469507"><a href="#local-6989586621679469507"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#isFull"><span class="hs-identifier hs-var">FileInfo.isFull</span></a><span> </span><a href="#local-6989586621679469496"><span class="hs-identifier hs-var">maxBlocksPerFile</span></a><span> </span><a href="#local-6989586621679469517"><span class="hs-identifier hs-var">fileInfo'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679469521"><span class="hs-identifier hs-var">st'</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-381"></a><span>        </span><a name="local-6989586621679469516"><a href="#local-6989586621679469516"><span class="hs-identifier">fileInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span>
</span><a name="line-382"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;VolatileDB invariant violation:&quot;</span><span>
</span><a name="line-383"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Current write file not found in Index.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>            </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#lookup"><span class="hs-identifier hs-var">Index.lookup</span></a><span> </span><a href="#local-6989586621679469510"><span class="hs-identifier hs-var">currentWriteId</span></a><span> </span><a href="#local-6989586621679469512"><span class="hs-identifier hs-var">currentMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>        </span><a name="local-6989586621679469517"><a href="#local-6989586621679469517"><span class="hs-identifier">fileInfo'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#addBlock"><span class="hs-identifier hs-var">FileInfo.addBlock</span></a><span> </span><a href="#local-6989586621679469502"><span class="hs-identifier hs-var">biSlotNo</span></a><span> </span><a href="#local-6989586621679469501"><span class="hs-identifier hs-var">biHash</span></a><span> </span><a href="#local-6989586621679469516"><span class="hs-identifier hs-var">fileInfo</span></a><span>
</span><a name="line-386"></a><span>        </span><a name="local-6989586621679469518"><a href="#local-6989586621679469518"><span class="hs-identifier">currentMap'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#insert"><span class="hs-identifier hs-var">Index.insert</span></a><span> </span><a href="#local-6989586621679469510"><span class="hs-identifier hs-var">currentWriteId</span></a><span> </span><a href="#local-6989586621679469517"><span class="hs-identifier hs-var">fileInfo'</span></a><span> </span><a href="#local-6989586621679469512"><span class="hs-identifier hs-var">currentMap</span></a><span>
</span><a name="line-387"></a><span>        </span><a name="local-6989586621679469519"><a href="#local-6989586621679469519"><span class="hs-identifier">internalBlockInfo'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#InternalBlockInfo"><span class="hs-identifier hs-var">InternalBlockInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-388"></a><span>            </span><span class="hs-identifier">ibiFile</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469509"><span class="hs-identifier hs-var">currentWritePath</span></a><span>
</span><a name="line-389"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ibiBlockOffset</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockOffset"><span class="hs-identifier hs-var">BlockOffset</span></a><span> </span><a href="#local-6989586621679469511"><span class="hs-identifier hs-var">currentWriteOffset</span></a><span>
</span><a name="line-390"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ibiBlockSize</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockSize"><span class="hs-identifier hs-var">BlockSize</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679469506"><span class="hs-identifier hs-var">bytesWritten</span></a><span>
</span><a name="line-391"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ibiBlockInfo</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469500"><span class="hs-identifier hs-var">blockInfo</span></a><span>
</span><a name="line-392"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ibiNestedCtxt</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Ouroboros.Consensus.Block.NestedContent.html#unnest"><span class="hs-identifier hs-var">unnest</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Block.Abstract.html#getHeader"><span class="hs-identifier hs-var">getHeader</span></a><span> </span><a href="#local-6989586621679469499"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-393"></a><span>                                </span><a href="Ouroboros.Consensus.Util.DepPair.html#DepPair"><span class="hs-identifier hs-var">DepPair</span></a><span> </span><a name="local-6989586621679469522"><a href="#local-6989586621679469522"><span class="hs-identifier">nestedCtxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Block.Abstract.html#SomeBlock"><span class="hs-identifier hs-var">SomeBlock</span></a><span> </span><a href="#local-6989586621679469522"><span class="hs-identifier hs-var">nestedCtxt</span></a><span>
</span><a name="line-394"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-395"></a><span>        </span><a name="local-6989586621679469520"><a href="#local-6989586621679469520"><span class="hs-identifier">currentRevMap'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679469501"><span class="hs-identifier hs-var">biHash</span></a><span> </span><a href="#local-6989586621679469519"><span class="hs-identifier hs-var">internalBlockInfo'</span></a><span> </span><a href="#local-6989586621679469513"><span class="hs-identifier hs-var">currentRevMap</span></a><span>
</span><a name="line-396"></a><span>        </span><a name="local-6989586621679469521"><a href="#local-6989586621679469521"><span class="hs-identifier">st'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469507"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-397"></a><span>            </span><span class="hs-identifier">currentWriteOffset</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469511"><span class="hs-identifier hs-var">currentWriteOffset</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679469506"><span class="hs-identifier hs-var">bytesWritten</span></a><span>
</span><a name="line-398"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentMap</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469518"><span class="hs-identifier hs-var">currentMap'</span></a><span>
</span><a name="line-399"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentRevMap</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469520"><span class="hs-identifier hs-var">currentRevMap'</span></a><span>
</span><a name="line-400"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentSuccMap</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#insertMapSet"><span class="hs-identifier hs-var">insertMapSet</span></a><span> </span><a href="#local-6989586621679469503"><span class="hs-identifier hs-var">biPrevHash</span></a><span> </span><a href="#local-6989586621679469501"><span class="hs-identifier hs-var">biHash</span></a><span> </span><a href="#local-6989586621679469514"><span class="hs-identifier hs-var">currentSuccMap</span></a><span>
</span><a name="line-401"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentMaxSlotNo</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469515"><span class="hs-identifier hs-var">currentMaxSlotNo</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-var">MaxSlotNo</span></a><span> </span><a href="#local-6989586621679469502"><span class="hs-identifier hs-var">biSlotNo</span></a><span>
</span><a name="line-402"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-comment">-- | Garbage collect all files of which the highest slot is less than the</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- given slot.</span><span>
</span><a name="line-406"></a><span class="hs-comment">--</span><span>
</span><a name="line-407"></a><span class="hs-comment">-- We first check whether we actually can garbage collect any file. If we can,</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- we obtain the more expensive write lock and remove the files that can be</span><span>
</span><a name="line-409"></a><span class="hs-comment">-- garbage collected. We update the 'InternalState' for each garbage collected</span><span>
</span><a name="line-410"></a><span class="hs-comment">-- file.</span><span>
</span><a name="line-411"></a><span class="hs-comment">--</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- If an exception is thrown while garbage collecting, we close the database.</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- This means we don't have to worry the file system getting out of sync with</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- the in-memory indices, as the indices are rebuilt when reopening.</span><span>
</span><a name="line-415"></a><span class="hs-comment">--</span><span>
</span><a name="line-416"></a><span class="hs-comment">-- NOTE: the current file is never garbage collected.</span><span>
</span><a name="line-417"></a><span class="hs-identifier">garbageCollectImpl</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-418"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469419"><a href="#local-6989586621679469419"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469420"><a href="#local-6989586621679469420"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469419"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469420"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469419"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469420"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>
</span><a name="line-421"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469419"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-422"></a><a name="garbageCollectImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectImpl"><span class="hs-identifier">garbageCollectImpl</span></a></a><span> </span><a name="local-6989586621679469529"><a href="#local-6989586621679469529"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679469530"><a href="#local-6989586621679469530"><span class="hs-identifier">slot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-423"></a><span>    </span><span class="hs-comment">-- Check if we can actually GC something using a cheaper read (allowing</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-comment">-- for more concurrency) before obtaining the more expensive exclusive</span><span>
</span><a name="line-425"></a><span>    </span><span class="hs-comment">-- write lock.</span><span>
</span><a name="line-426"></a><span>    </span><a name="local-6989586621679469539"><a href="#local-6989586621679469539"><span class="hs-identifier">usefulGC</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a><span> </span><a href="#local-6989586621679469531"><span class="hs-identifier hs-var">gcPossible</span></a><span> </span><a href="#local-6989586621679469529"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679469539"><span class="hs-identifier hs-var">usefulGC</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-429"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#writeOpenState"><span class="hs-identifier hs-var">writeOpenState</span></a><span> </span><a href="#local-6989586621679469529"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469540"><a href="#local-6989586621679469540"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-430"></a><span>        </span><span class="hs-comment">-- This event will be picked up by ghc-events-analyze</span><span>
</span><a name="line-431"></a><span>        </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadEventlog.html#traceEventM"><span class="hs-identifier hs-var">traceEventM</span></a><span> </span><span class="hs-string">&quot;START garbage collection&quot;</span><span>
</span><a name="line-432"></a><span>        </span><span class="hs-comment">-- Note that this is /monotonic/: if 'usefulGC' is @True@, then</span><span>
</span><a name="line-433"></a><span>        </span><span class="hs-comment">-- 'filesToGC' has to be non-empty.</span><span>
</span><a name="line-434"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-comment">-- Only a single thread performs garbage collection, so no files could</span><span>
</span><a name="line-436"></a><span>        </span><span class="hs-comment">-- have been GC'ed in the meantime. The only thing that could have</span><span>
</span><a name="line-437"></a><span>        </span><span class="hs-comment">-- happened is that blocks have been appended. If they have been</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-comment">-- appended to the current file, nothing changes, as we never GC the</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-comment">-- current file anyway. If a new file was opened, either we can now GC</span><span>
</span><a name="line-440"></a><span>        </span><span class="hs-comment">-- the previous file (increase in the number of files to GC) or not</span><span>
</span><a name="line-441"></a><span>        </span><span class="hs-comment">-- (same number of files to GC).</span><span>
</span><a name="line-442"></a><span>        </span><a name="local-6989586621679469541"><a href="#local-6989586621679469541"><span class="hs-identifier">filesToGC</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><a href="#local-6989586621679469532"><span class="hs-identifier hs-var">getFilesToGC</span></a><span>
</span><a name="line-443"></a><span>        </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectFile"><span class="hs-identifier hs-var">garbageCollectFile</span></a><span> </span><a href="#local-6989586621679469540"><span class="hs-identifier hs-var">hasFS</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679469541"><span class="hs-identifier hs-var">filesToGC</span></a><span>
</span><a name="line-444"></a><span>        </span><span class="hs-comment">-- Recompute the 'MaxSlotNo' based on the files left in the</span><span>
</span><a name="line-445"></a><span>        </span><span class="hs-comment">-- VolatileDB. This value can never go down, except to 'NoMaxSlotNo'</span><span>
</span><a name="line-446"></a><span>        </span><span class="hs-comment">-- (when we GC everything), because a GC can only delete blocks &lt; a</span><span>
</span><a name="line-447"></a><span>        </span><span class="hs-comment">-- slot.</span><span>
</span><a name="line-448"></a><span>        </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469542"><a href="#local-6989586621679469542"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469542"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-449"></a><span>            </span><span class="hs-identifier">currentMaxSlotNo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#maxSlotNoInFiles"><span class="hs-identifier hs-var">FileInfo.maxSlotNoInFiles</span></a><span>
</span><a name="line-450"></a><span>                                 </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#elems"><span class="hs-identifier hs-var">Index.elems</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">currentMap</span><span> </span><a href="#local-6989586621679469542"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-452"></a><span>        </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadEventlog.html#traceEventM"><span class="hs-identifier hs-var">traceEventM</span></a><span> </span><span class="hs-string">&quot;STOP garbage collection&quot;</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-454"></a><span>    </span><span class="hs-comment">-- | Return 'True' if a garbage collection would actually garbage collect</span><span>
</span><a name="line-455"></a><span>    </span><span class="hs-comment">-- at least one file.</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-identifier">gcPossible</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679469420"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469533"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-457"></a><span>    </span><a name="local-6989586621679469531"><a href="#local-6989586621679469531"><span class="hs-identifier">gcPossible</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679469532"><span class="hs-identifier hs-var">getFilesToGC</span></a><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span>    </span><span class="hs-comment">-- | Return the list of files that can be garbage collected.</span><span>
</span><a name="line-460"></a><span>    </span><span class="hs-identifier">getFilesToGC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679469420"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469534"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#FileId"><span class="hs-identifier hs-type">FileId</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span> </span><a href="#local-6989586621679469420"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-461"></a><span>    </span><a name="local-6989586621679469532"><a href="#local-6989586621679469532"><span class="hs-identifier">getFilesToGC</span></a></a><span> </span><a name="local-6989586621679469535"><a href="#local-6989586621679469535"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679469536"><span class="hs-identifier hs-var">canGC</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#toAscList"><span class="hs-identifier hs-var">Index.toAscList</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">currentMap</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679469535"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-462"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-comment">-- We don't GC the current file. This is unlikely to happen in</span><span>
</span><a name="line-464"></a><span>        </span><span class="hs-comment">-- practice anyway, and it makes things simpler.</span><span>
</span><a name="line-465"></a><span>        </span><a name="local-6989586621679469536"><a href="#local-6989586621679469536"><span class="hs-identifier">canGC</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679469537"><a href="#local-6989586621679469537"><span class="hs-identifier">fileId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469538"><a href="#local-6989586621679469538"><span class="hs-identifier">fileInfo</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-466"></a><span>          </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#canGC"><span class="hs-identifier hs-var">FileInfo.canGC</span></a><span> </span><a href="#local-6989586621679469538"><span class="hs-identifier hs-var">fileInfo</span></a><span> </span><a href="#local-6989586621679469530"><span class="hs-identifier hs-var">slot</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679469537"><span class="hs-identifier hs-var">fileId</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">currentWriteId</span><span> </span><a href="#local-6989586621679469535"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span class="hs-comment">-- | Garbage collect the given file /unconditionally/, updating the</span><span>
</span><a name="line-469"></a><span class="hs-comment">-- 'OpenState'.</span><span>
</span><a name="line-470"></a><span class="hs-comment">--</span><span>
</span><a name="line-471"></a><span class="hs-comment">-- Important to note here is that, every call should leave the file system in</span><span>
</span><a name="line-472"></a><span class="hs-comment">-- a consistent state, without depending on other calls. We achieve this by</span><span>
</span><a name="line-473"></a><span class="hs-comment">-- only needed a single system call: 'removeFile'.</span><span>
</span><a name="line-474"></a><span class="hs-comment">--</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- NOTE: the updated 'OpenState' is inconsistent in the follow respect:</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- the cached 'currentMaxSlotNo' hasn't been updated yet.</span><span>
</span><a name="line-477"></a><span class="hs-comment">--</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- This may throw an FsError.</span><span>
</span><a name="line-479"></a><span class="hs-identifier">garbageCollectFile</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-480"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469416"><a href="#local-6989586621679469416"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469417"><a href="#local-6989586621679469417"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679469418"><a href="#local-6989586621679469418"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadThrow"><span class="hs-identifier hs-type">MonadThrow</span></a><span> </span><a href="#local-6989586621679469416"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469418"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679469416"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469417"><span class="hs-identifier hs-type">h</span></a><span>
</span><a name="line-482"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#FileId"><span class="hs-identifier hs-type">FileId</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span> </span><a href="#local-6989586621679469418"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a><span> </span><a href="#local-6989586621679469416"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469418"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469417"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><a name="garbageCollectFile"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectFile"><span class="hs-identifier">garbageCollectFile</span></a></a><span> </span><a name="local-6989586621679469543"><a href="#local-6989586621679469543"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679469544"><a href="#local-6989586621679469544"><span class="hs-identifier">fileId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469545"><a href="#local-6989586621679469545"><span class="hs-identifier">fileInfo</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span>    </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">removeFile</span><span> </span><a href="#local-6989586621679469543"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#filePath"><span class="hs-identifier hs-var">filePath</span></a><span> </span><a href="#local-6989586621679469544"><span class="hs-identifier hs-var">fileId</span></a><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span>    </span><a name="local-6989586621679469546"><a href="#local-6989586621679469546"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469547"><a href="#local-6989586621679469547"><span class="hs-identifier">currentMap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469548"><a href="#local-6989586621679469548"><span class="hs-identifier">currentRevMap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469549"><a href="#local-6989586621679469549"><span class="hs-identifier">currentSuccMap</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679469550"><a href="#local-6989586621679469550"><span class="hs-identifier">hashes</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">FileInfo.hashes</span><span> </span><a href="#local-6989586621679469545"><span class="hs-identifier hs-var">fileInfo</span></a><span>
</span><a name="line-491"></a><span>        </span><a name="local-6989586621679469551"><a href="#local-6989586621679469551"><span class="hs-identifier">currentRevMap'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.withoutKeys</span><span> </span><a href="#local-6989586621679469548"><span class="hs-identifier hs-var">currentRevMap</span></a><span> </span><a href="#local-6989586621679469550"><span class="hs-identifier hs-var">hashes</span></a><span>
</span><a name="line-492"></a><span>        </span><a name="local-6989586621679469552"><a href="#local-6989586621679469552"><span class="hs-identifier">deletedPairs</span></a></a><span>    </span><span class="hs-glyph">=</span><span>
</span><a name="line-493"></a><span>          </span><span class="hs-identifier hs-var">mapMaybe</span><span>
</span><a name="line-494"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679469554"><a href="#local-6989586621679469554"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679469554"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">biPrevHash</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ibiBlockInfo</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679469554"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679469548"><span class="hs-identifier hs-var">currentRevMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679469550"><span class="hs-identifier hs-var">hashes</span></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>        </span><a name="local-6989586621679469553"><a href="#local-6989586621679469553"><span class="hs-identifier">currentSuccMap'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-497"></a><span>          </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#deleteMapSet"><span class="hs-identifier hs-var">deleteMapSet</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679469549"><span class="hs-identifier hs-var">currentSuccMap</span></a><span> </span><a href="#local-6989586621679469552"><span class="hs-identifier hs-var">deletedPairs</span></a><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span>    </span><span class="hs-identifier hs-var">put</span><span> </span><a href="#local-6989586621679469546"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-500"></a><span>        </span><span class="hs-identifier">currentMap</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#delete"><span class="hs-identifier hs-var">Index.delete</span></a><span> </span><a href="#local-6989586621679469544"><span class="hs-identifier hs-var">fileId</span></a><span> </span><a href="#local-6989586621679469547"><span class="hs-identifier hs-var">currentMap</span></a><span>
</span><a name="line-501"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentRevMap</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469551"><span class="hs-identifier hs-var">currentRevMap'</span></a><span>
</span><a name="line-502"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentSuccMap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469553"><span class="hs-identifier hs-var">currentSuccMap'</span></a><span>
</span><a name="line-503"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-identifier">filterByPredecessorImpl</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-506"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469414"><a href="#local-6989586621679469414"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469415"><a href="#local-6989586621679469415"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469414"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469415"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469414"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469415"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-508"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679469414"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#ChainHash"><span class="hs-identifier hs-type">ChainHash</span></a><span> </span><a href="#local-6989586621679469415"><span class="hs-identifier hs-type">blk</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679469415"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><a name="filterByPredecessorImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#filterByPredecessorImpl"><span class="hs-identifier">filterByPredecessorImpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469555"><a href="#local-6989586621679469555"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679469556"><a href="#local-6989586621679469556"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-510"></a><span>    </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679469556"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">currentSuccMap</span><span> </span><a href="#local-6989586621679469555"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-identifier">getBlockInfoImpl</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-513"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469412"><a href="#local-6989586621679469412"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469413"><a href="#local-6989586621679469413"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469412"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679469413"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469412"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469413"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679469412"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679469413"><span class="hs-identifier hs-type">blk</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#BlockInfo"><span class="hs-identifier hs-type">BlockInfo</span></a><span> </span><a href="#local-6989586621679469413"><span class="hs-identifier hs-type">blk</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><a name="getBlockInfoImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockInfoImpl"><span class="hs-identifier">getBlockInfoImpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679469557"><a href="#local-6989586621679469557"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679469558"><a href="#local-6989586621679469558"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-identifier">ibiBlockInfo</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679469558"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">currentRevMap</span><span> </span><a href="#local-6989586621679469557"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-identifier">getMaxSlotNoImpl</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-520"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469410"><a href="#local-6989586621679469410"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469411"><a href="#local-6989586621679469411"><span class="hs-identifier">blockId</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469410"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-521"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469410"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469411"><span class="hs-identifier hs-type">blockId</span></a><span>
</span><a name="line-522"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679469410"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src/Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span>
</span><a name="line-523"></a><a name="getMaxSlotNoImpl"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getMaxSlotNoImpl"><span class="hs-identifier">getMaxSlotNoImpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a><span> </span><span class="hs-identifier">currentMaxSlotNo</span><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span class="hs-comment">{------------------------------------------------------------------------------
  Internal functions
------------------------------------------------------------------------------}</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span class="hs-comment">-- | Creates a new file and updates the 'OpenState' accordingly.</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- This may throw an FsError.</span><span>
</span><a name="line-531"></a><span class="hs-identifier">nextFile</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-532"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469407"><a href="#local-6989586621679469407"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679469408"><a href="#local-6989586621679469408"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469409"><a href="#local-6989586621679469409"><span class="hs-identifier">blk</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469408"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679469407"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679469408"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469407"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a><span> </span><a href="#local-6989586621679469408"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469409"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469407"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-534"></a><a name="nextFile"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#nextFile"><span class="hs-identifier">nextFile</span></a></a><span> </span><a name="local-6989586621679469559"><a href="#local-6989586621679469559"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-535"></a><span>    </span><a name="local-6989586621679469560"><a href="#local-6989586621679469560"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">currentWriteHandle</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679469561"><a href="#local-6989586621679469561"><span class="hs-identifier">curHndl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469562"><a href="#local-6989586621679469562"><span class="hs-identifier">currentWriteId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679469563"><a href="#local-6989586621679469563"><span class="hs-identifier">currentMap</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679469564"><a href="#local-6989586621679469564"><span class="hs-identifier">currentWriteId'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469562"><span class="hs-identifier hs-var">currentWriteId</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-538"></a><span>        </span><a name="local-6989586621679469565"><a href="#local-6989586621679469565"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#filePath"><span class="hs-identifier hs-var">filePath</span></a><span> </span><a href="#local-6989586621679469564"><span class="hs-identifier hs-var">currentWriteId'</span></a><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span>    </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hClose</span><span> </span><a href="#local-6989586621679469559"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469561"><span class="hs-identifier hs-var">curHndl</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>    </span><a name="local-6989586621679469566"><a href="#local-6989586621679469566"><span class="hs-identifier">hndl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var">allocateTemp</span></a><span>
</span><a name="line-543"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">hOpen</span><span>   </span><a href="#local-6989586621679469559"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679469565"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AppendMode"><span class="hs-identifier hs-var">AppendMode</span></a><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#MustBeNew"><span class="hs-identifier hs-var">MustBeNew</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>      </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose%27"><span class="hs-identifier hs-var">hClose'</span></a><span> </span><a href="#local-6989586621679469559"><span class="hs-identifier hs-var">hasFS</span></a><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">currentWriteHandle</span><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>    </span><span class="hs-identifier hs-var">put</span><span> </span><a href="#local-6989586621679469560"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-identifier">currentWriteHandle</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469566"><span class="hs-identifier hs-var">hndl</span></a><span>
</span><a name="line-548"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentWritePath</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469565"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-549"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentWriteId</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679469564"><span class="hs-identifier hs-var">currentWriteId'</span></a><span>
</span><a name="line-550"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentWriteOffset</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-551"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentMap</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#insert"><span class="hs-identifier hs-var">Index.insert</span></a><span> </span><a href="#local-6989586621679469564"><span class="hs-identifier hs-var">currentWriteId'</span></a><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#empty"><span class="hs-identifier hs-var">FileInfo.empty</span></a><span>
</span><a name="line-552"></a><span>                                </span><a href="#local-6989586621679469563"><span class="hs-identifier hs-var">currentMap</span></a><span>
</span><a name="line-553"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-comment">-- | Gets part of the 'OpenState' in 'STM'.</span><span>
</span><a name="line-556"></a><span class="hs-identifier">getterSTM</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-557"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469403"><a href="#local-6989586621679469403"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679469404"><a href="#local-6989586621679469404"><span class="hs-identifier">blk</span></a></a><span> </span><a name="local-6989586621679469405"><a href="#local-6989586621679469405"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679469403"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-558"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679469406"><a href="#local-6989586621679469406"><span class="hs-identifier">h</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679469404"><span class="hs-identifier hs-type">blk</span></a><span> </span><a href="#local-6989586621679469406"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679469405"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a><span> </span><a href="#local-6989586621679469403"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469404"><span class="hs-identifier hs-type">blk</span></a><span>
</span><a name="line-560"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679469403"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679469405"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-561"></a><a name="getterSTM"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier">getterSTM</span></a></a><span> </span><a name="local-6989586621679469567"><a href="#local-6989586621679469567"><span class="hs-identifier">fromSt</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-var">VolatileDBEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679469568"><a href="#local-6989586621679469568"><span class="hs-identifier">varInternalState</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-562"></a><span>    </span><a name="local-6989586621679469569"><a href="#local-6989586621679469569"><span class="hs-identifier">mSt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html#read"><span class="hs-identifier hs-var">RAWLock.read</span></a><span> </span><a href="#local-6989586621679469568"><span class="hs-identifier hs-var">varInternalState</span></a><span>
</span><a name="line-563"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679469569"><span class="hs-identifier hs-var">mSt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-564"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#ApiMisuse"><span class="hs-identifier hs-var">ApiMisuse</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#ClosedDBError"><span class="hs-identifier hs-var">ClosedDBError</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-565"></a><span>      </span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a name="local-6989586621679469570"><a href="#local-6989586621679469570"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679469567"><span class="hs-identifier hs-var">fromSt</span></a><span> </span><a href="#local-6989586621679469570"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-566"></a></pre></body></html>