<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass      #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-comment">-- | Hot key</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Intended for qualified import</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Shelley.Protocol.HotKey</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><span class="hs-comment">-- * KES Info</span><span>
</span><a name="line-13"></a><span>    </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolution"><span class="hs-identifier hs-type">KESEvolution</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesAbsolutePeriod"><span class="hs-identifier hs-var">kesAbsolutePeriod</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-comment">-- * KES Status</span><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESStatus"><span class="hs-identifier hs-type">KESStatus</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesStatus"><span class="hs-identifier hs-var">kesStatus</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-comment">-- * Hot Key</span><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionError"><span class="hs-identifier hs-type">KESEvolutionError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionInfo"><span class="hs-identifier hs-type">KESEvolutionInfo</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#HotKey"><span class="hs-identifier hs-type">HotKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#sign"><span class="hs-identifier hs-var">sign</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#mkHotKey"><span class="hs-identifier hs-var">mkHotKey</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Generics</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Stack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src/Cardano.Crypto.KES.html"><span class="hs-identifier">Cardano.Crypto.KES</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Relative</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src/Cardano.Crypto.KES.Class.html#Period"><span class="hs-identifier hs-type">Period</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#UpdateInfo"><span class="hs-identifier hs-type">UpdateInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html"><span class="hs-identifier">Shelley.Spec.Ledger.Keys</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SL</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html"><span class="hs-identifier">Shelley.Spec.Ledger.OCert</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Absolute</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">KESPeriod</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Shelley.Protocol.Crypto.html"><span class="hs-identifier">Ouroboros.Consensus.Shelley.Protocol.Crypto</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Cardano.Ledger.Era.html#Era"><span class="hs-identifier hs-type">Era</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  KES Info
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-comment">-- | We call the relative periods that a KES key is valid its evolution, to</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- avoid confusion with absolute periods.</span><span>
</span><a name="line-47"></a><span class="hs-keyword">type</span><span> </span><a name="KESEvolution"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolution"><span class="hs-identifier">KESEvolution</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src/Cardano.Crypto.KES.Class.html#Period"><span class="hs-identifier hs-type">Relative.Period</span></a><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">data</span><span> </span><a name="KESInfo"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier">KESInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="KESInfo"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier">KESInfo</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-50"></a><span>      </span><a name="kesStartPeriod"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesStartPeriod"><span class="hs-identifier">kesStartPeriod</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>
</span><a name="line-51"></a><span>   </span><span class="hs-special">,</span><span>  </span><a name="kesEndPeriod"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesEndPeriod"><span class="hs-identifier">kesEndPeriod</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>
</span><a name="line-52"></a><span>      </span><span class="hs-comment">-- ^ Currently derived from 'TPraosParams':</span><span>
</span><a name="line-53"></a><span>      </span><span class="hs-comment">-- &gt; kesEndPeriod = kesStartPeriod + tpraosMaxKESEvo</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="kesEvolution"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesEvolution"><span class="hs-identifier">kesEvolution</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolution"><span class="hs-identifier hs-type">KESEvolution</span></a><span>
</span><a name="line-55"></a><span>      </span><span class="hs-comment">-- ^ Current evolution or /relative period/.</span><span>
</span><a name="line-56"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-57"></a><span>      </span><span class="hs-comment">-- Invariant:</span><span>
</span><a name="line-58"></a><span>      </span><span class="hs-comment">-- &gt; kesStartPeriod + kesEvolution in [kesStartPeriod, kesEndPeriod)</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Return the absolute KES period</span><span>
</span><a name="line-63"></a><span class="hs-identifier">kesAbsolutePeriod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>
</span><a name="line-64"></a><a name="kesAbsolutePeriod"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesAbsolutePeriod"><span class="hs-identifier">kesAbsolutePeriod</span></a></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-var">KESInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679166282"><a href="#local-6989586621679166282"><span class="hs-identifier">kesStartPeriod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679166283"><a href="#local-6989586621679166283"><span class="hs-identifier">kesEvolution</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-65"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679166284"><span class="hs-identifier hs-var">start</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679166283"><span class="hs-identifier hs-var">kesEvolution</span></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-67"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><a name="local-6989586621679166284"><a href="#local-6989586621679166284"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679166282"><span class="hs-identifier hs-var">kesStartPeriod</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  KES Status
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">data</span><span> </span><a name="KESStatus"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESStatus"><span class="hs-identifier">KESStatus</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- | The given period is before the start period of the KES key.</span><span>
</span><a name="line-75"></a><span>    </span><a name="BeforeKESStart"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#BeforeKESStart"><span class="hs-identifier">BeforeKESStart</span></a></a><span>
</span><a name="line-76"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>  </span><span class="hs-comment">-- ^ Given period</span><span>
</span><a name="line-77"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>  </span><span class="hs-comment">-- ^ Start period of the KES key</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-comment">-- | The given period is in the range of the KES key.</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InKESRange"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#InKESRange"><span class="hs-identifier">InKESRange</span></a></a><span>
</span><a name="line-81"></a><span>      </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolution"><span class="hs-identifier hs-type">KESEvolution</span></a><span>  </span><span class="hs-comment">-- ^ Relative period or evolution corresponding to the</span><span>
</span><a name="line-82"></a><span>                    </span><span class="hs-comment">-- given absolute period</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>    </span><span class="hs-comment">-- | The given period is after the end period of the KES key.</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AfterKESEnd"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#AfterKESEnd"><span class="hs-identifier">AfterKESEnd</span></a></a><span>
</span><a name="line-86"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>  </span><span class="hs-comment">-- ^ Given period</span><span>
</span><a name="line-87"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>  </span><span class="hs-comment">-- ^ End period of the KES key</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- | Return the evolution of the given KES period, /when/ it falls within the</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- range of the 'HotKey' (@[hkStart, hkEnd)@).</span><span>
</span><a name="line-91"></a><span class="hs-comment">--</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- Note that the upper bound is exclusive, the spec says:</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- &gt; c0 &lt;= kesPeriod s &lt; c0 + MaxKESEvo</span><span>
</span><a name="line-94"></a><span class="hs-identifier">kesStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESStatus"><span class="hs-identifier hs-type">KESStatus</span></a><span>
</span><a name="line-95"></a><a name="kesStatus"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesStatus"><span class="hs-identifier">kesStatus</span></a></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-var">KESInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">kesStartPeriod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679166285"><a href="#local-6989586621679166285"><span class="hs-identifier">lo'</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><a name="local-6989586621679166286"><a href="#local-6989586621679166286"><span class="hs-identifier">lo</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kesEndPeriod</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679166287"><a href="#local-6989586621679166287"><span class="hs-identifier">hi'</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><a name="local-6989586621679166288"><a href="#local-6989586621679166288"><span class="hs-identifier">hi</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-98"></a><span>          </span><a name="local-6989586621679166289"><a href="#local-6989586621679166289"><span class="hs-identifier">cur'</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><a name="local-6989586621679166290"><a href="#local-6989586621679166290"><span class="hs-identifier">cur</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679166290"><span class="hs-identifier hs-var">cur</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span>  </span><a href="#local-6989586621679166286"><span class="hs-identifier hs-var">lo</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#BeforeKESStart"><span class="hs-identifier hs-var">BeforeKESStart</span></a><span> </span><a href="#local-6989586621679166289"><span class="hs-identifier hs-var">cur'</span></a><span> </span><a href="#local-6989586621679166285"><span class="hs-identifier hs-var">lo'</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679166290"><span class="hs-identifier hs-var">cur</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679166288"><span class="hs-identifier hs-var">hi</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#AfterKESEnd"><span class="hs-identifier hs-var">AfterKESEnd</span></a><span> </span><a href="#local-6989586621679166289"><span class="hs-identifier hs-var">cur'</span></a><span> </span><a href="#local-6989586621679166287"><span class="hs-identifier hs-var">hi'</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#InKESRange"><span class="hs-identifier hs-var">InKESRange</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166290"><span class="hs-identifier hs-var">cur</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679166286"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Hot Key
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- | Failed to evolve the KES key.</span><span>
</span><a name="line-108"></a><span class="hs-keyword">data</span><span> </span><a name="KESEvolutionError"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionError"><span class="hs-identifier">KESEvolutionError</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-comment">-- | The KES key could not be evolved to the target period.</span><span>
</span><a name="line-110"></a><span>    </span><a name="KESCouldNotEvolve"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESCouldNotEvolve"><span class="hs-identifier">KESCouldNotEvolve</span></a></a><span>
</span><a name="line-111"></a><span>      </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span>
</span><a name="line-112"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">-- ^ Target period outside the range of the current KES key. Typically</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-comment">-- the current KES period according to the wallclock slot.</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-comment">-- | The KES key was already poisoned.</span><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="KESKeyAlreadyPoisoned"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyAlreadyPoisoned"><span class="hs-identifier">KESKeyAlreadyPoisoned</span></a></a><span>
</span><a name="line-118"></a><span>      </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span>
</span><a name="line-119"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>
</span><a name="line-120"></a><span>        </span><span class="hs-comment">-- ^ Target period outside the range of the current KES key. Typically</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-comment">-- the current KES period according to the wallclock slot.</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | Result of evolving the KES key.</span><span>
</span><a name="line-125"></a><span class="hs-keyword">type</span><span> </span><a name="KESEvolutionInfo"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionInfo"><span class="hs-identifier">KESEvolutionInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#UpdateInfo"><span class="hs-identifier hs-type">UpdateInfo</span></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionError"><span class="hs-identifier hs-type">KESEvolutionError</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">-- | API to interact with the key.</span><span>
</span><a name="line-128"></a><span class="hs-keyword">data</span><span> </span><a name="HotKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#HotKey"><span class="hs-identifier">HotKey</span></a></a><span> </span><a name="local-6989586621679166192"><a href="#local-6989586621679166192"><span class="hs-identifier">era</span></a></a><span> </span><a name="local-6989586621679166193"><a href="#local-6989586621679166193"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="HotKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#HotKey"><span class="hs-identifier">HotKey</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-129"></a><span>      </span><span class="hs-comment">-- | Evolve the KES signing key to the given absolute KES period.</span><span>
</span><a name="line-130"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span>      </span><span class="hs-comment">-- When the key cannot evolve anymore, we poison it.</span><span>
</span><a name="line-132"></a><span>      </span><a name="evolve"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#evolve"><span class="hs-identifier">evolve</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166193"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionInfo"><span class="hs-identifier hs-type">KESEvolutionInfo</span></a><span>
</span><a name="line-133"></a><span>      </span><span class="hs-comment">-- | Return 'KESInfo' of the signing key.</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="getInfo"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#getInfo"><span class="hs-identifier">getInfo</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679166193"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span>
</span><a name="line-135"></a><span>      </span><span class="hs-comment">-- | Return 'True' when the signing key is poisoned because it expired.</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="isPoisoned"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#isPoisoned"><span class="hs-identifier">isPoisoned</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679166193"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-137"></a><span>      </span><span class="hs-comment">-- | Sign the given @toSign@ with the current signing key.</span><span>
</span><a name="line-138"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-139"></a><span>      </span><span class="hs-comment">-- PRECONDITION: the key is not poisoned.</span><span>
</span><a name="line-140"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-141"></a><span>      </span><span class="hs-comment">-- POSTCONDITION: the signature is in normal form.</span><span>
</span><a name="line-142"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sign_"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#sign_"><span class="hs-identifier">sign_</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679166194"><a href="#local-6989586621679166194"><span class="hs-identifier">toSign</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#KESignable"><span class="hs-identifier hs-type">SL.KESignable</span></a><span> </span><a href="#local-6989586621679166192"><span class="hs-identifier hs-type">era</span></a><span> </span><a href="#local-6989586621679166194"><span class="hs-identifier hs-type">toSign</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679166194"><span class="hs-identifier hs-type">toSign</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166193"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#SignedKES"><span class="hs-identifier hs-type">SL.SignedKES</span></a><span> </span><a href="#local-6989586621679166192"><span class="hs-identifier hs-type">era</span></a><span> </span><a href="#local-6989586621679166194"><span class="hs-identifier hs-type">toSign</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">sign</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-147"></a><span>     </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#KESignable"><span class="hs-identifier hs-type">SL.KESignable</span></a><span> </span><a href="#local-6989586621679166279"><span class="hs-identifier hs-type">era</span></a><span> </span><a href="#local-6989586621679166280"><span class="hs-identifier hs-type">toSign</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#HotKey"><span class="hs-identifier hs-type">HotKey</span></a><span> </span><a href="#local-6989586621679166279"><span class="hs-identifier hs-type">era</span></a><span> </span><a href="#local-6989586621679166281"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-149"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166280"><span class="hs-identifier hs-type">toSign</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166281"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#SignedKES"><span class="hs-identifier hs-type">SL.SignedKES</span></a><span> </span><a href="#local-6989586621679166279"><span class="hs-identifier hs-type">era</span></a><span> </span><a href="#local-6989586621679166280"><span class="hs-identifier hs-type">toSign</span></a><span class="hs-special">)</span><span>
</span><a name="line-150"></a><a name="sign"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#sign"><span class="hs-identifier">sign</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sign_</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-comment">-- | The actual KES key, unless it expired, in which case it is replaced by</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- \&quot;poison\&quot;.</span><span>
</span><a name="line-154"></a><span class="hs-keyword">data</span><span> </span><a name="KESKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier">KESKey</span></a></a><span> </span><a name="local-6989586621679166191"><a href="#local-6989586621679166191"><span class="hs-identifier">era</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-155"></a><span>    </span><a name="KESKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier">KESKey</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#SignKeyKES"><span class="hs-identifier hs-type">SL.SignKeyKES</span></a><span> </span><a href="#local-6989586621679166191"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="KESKeyPoisoned"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyPoisoned"><span class="hs-identifier">KESKeyPoisoned</span></a></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-keyword">instance</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Cardano.Ledger.Era.html#Era"><span class="hs-identifier hs-type">Era</span></a><span> </span><a href="#local-6989586621679166243"><span class="hs-identifier hs-type">era</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-type">KESKey</span></a><span> </span><a href="#local-6989586621679166243"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-identifier">kesKeyIsPoisoned</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-type">KESKey</span></a><span> </span><a href="#local-6989586621679166278"><span class="hs-identifier hs-type">era</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-162"></a><a name="kesKeyIsPoisoned"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesKeyIsPoisoned"><span class="hs-identifier">kesKeyIsPoisoned</span></a></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyPoisoned"><span class="hs-identifier hs-var">KESKeyPoisoned</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-163"></a><span class="hs-identifier">kesKeyIsPoisoned</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-var">KESKey</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-keyword">data</span><span> </span><a name="KESState"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier">KESState</span></a></a><span> </span><a name="local-6989586621679166190"><a href="#local-6989586621679166190"><span class="hs-identifier">era</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="KESState"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier">KESState</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-166"></a><span>      </span><a name="kesStateInfo"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesStateInfo"><span class="hs-identifier">kesStateInfo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span>
</span><a name="line-167"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="kesStateKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesStateKey"><span class="hs-identifier">kesStateKey</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-type">KESKey</span></a><span> </span><a href="#local-6989586621679166190"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-169"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-keyword">instance</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Cardano.Ledger.Era.html#Era"><span class="hs-identifier hs-type">Era</span></a><span> </span><a href="#local-6989586621679166242"><span class="hs-identifier hs-type">era</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-type">KESState</span></a><span> </span><a href="#local-6989586621679166242"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">mkHotKey</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-174"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679166276"><a href="#local-6989586621679166276"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679166277"><a href="#local-6989586621679166277"><span class="hs-identifier">era</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Cardano.Ledger.Era.html#Era"><span class="hs-identifier hs-type">Era</span></a><span> </span><a href="#local-6989586621679166277"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679166276"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#SignKeyKES"><span class="hs-identifier hs-type">SL.SignKeyKES</span></a><span> </span><a href="#local-6989586621679166277"><span class="hs-identifier hs-type">era</span></a><span>
</span><a name="line-176"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span>  </span><span class="hs-comment">-- ^ Start period</span><span>
</span><a name="line-177"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>              </span><span class="hs-comment">-- ^ Max KES evolutions</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166276"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#HotKey"><span class="hs-identifier hs-type">HotKey</span></a><span> </span><a href="#local-6989586621679166277"><span class="hs-identifier hs-type">era</span></a><span> </span><a href="#local-6989586621679166276"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><a name="mkHotKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#mkHotKey"><span class="hs-identifier">mkHotKey</span></a></a><span> </span><a name="local-6989586621679166291"><a href="#local-6989586621679166291"><span class="hs-identifier">initKey</span></a></a><span> </span><a name="local-6989586621679166292"><a href="#local-6989586621679166292"><span class="hs-identifier">startPeriod</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><a name="local-6989586621679166293"><a href="#local-6989586621679166293"><span class="hs-identifier">start</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679166294"><a href="#local-6989586621679166294"><span class="hs-identifier">maxKESEvolutions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-180"></a><span>    </span><a name="local-6989586621679166304"><a href="#local-6989586621679166304"><span class="hs-identifier">varKESState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.MonadSTM.NormalForm.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a><span> </span><a href="#local-6989586621679166295"><span class="hs-identifier hs-var">initKESState</span></a><span>
</span><a name="line-181"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#HotKey"><span class="hs-identifier hs-var">HotKey</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-identifier">evolve</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#evolveKey"><span class="hs-identifier hs-var">evolveKey</span></a><span> </span><a href="#local-6989586621679166304"><span class="hs-identifier hs-var">varKESState</span></a><span>
</span><a name="line-183"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getInfo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">kesStateInfo</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a><span> </span><a href="#local-6989586621679166304"><span class="hs-identifier hs-var">varKESState</span></a><span>
</span><a name="line-184"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isPoisoned</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesKeyIsPoisoned"><span class="hs-identifier hs-var">kesKeyIsPoisoned</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">kesStateKey</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a><span> </span><a href="#local-6989586621679166304"><span class="hs-identifier hs-var">varKESState</span></a><span>
</span><a name="line-185"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sign_</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679166305"><a href="#local-6989586621679166305"><span class="hs-identifier">toSign</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-186"></a><span>          </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-var">KESState</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679166306"><a href="#local-6989586621679166306"><span class="hs-identifier">kesStateInfo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679166307"><a href="#local-6989586621679166307"><span class="hs-identifier">kesStateKey</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a><span> </span><a href="#local-6989586621679166304"><span class="hs-identifier hs-var">varKESState</span></a><span>
</span><a name="line-187"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679166307"><span class="hs-identifier hs-var">kesStateKey</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-188"></a><span>            </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyPoisoned"><span class="hs-identifier hs-var">KESKeyPoisoned</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;trying to sign with a poisoned key&quot;</span><span>
</span><a name="line-189"></a><span>            </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-var">KESKey</span></a><span> </span><a name="local-6989586621679166308"><a href="#local-6989586621679166308"><span class="hs-identifier">key</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-190"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679166309"><a href="#local-6989586621679166309"><span class="hs-identifier">evolution</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">kesEvolution</span><span> </span><a href="#local-6989586621679166306"><span class="hs-identifier hs-var">kesStateInfo</span></a><span>
</span><a name="line-191"></a><span>                  </span><a name="local-6989586621679166310"><a href="#local-6989586621679166310"><span class="hs-identifier">signed</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src/Cardano.Crypto.KES.Class.html#signedKES"><span class="hs-identifier hs-var">SL.signedKES</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679166309"><span class="hs-identifier hs-var">evolution</span></a><span> </span><a href="#local-6989586621679166305"><span class="hs-identifier hs-var">toSign</span></a><span> </span><a href="#local-6989586621679166308"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-192"></a><span>              </span><span class="hs-comment">-- Force the signature to WHNF (for 'SignedKES', WHNF implies</span><span>
</span><a name="line-193"></a><span>              </span><span class="hs-comment">-- NF) so that we don't have any thunks holding on to a key that</span><span>
</span><a name="line-194"></a><span>              </span><span class="hs-comment">-- might be destructively updated when evolved.</span><span>
</span><a name="line-195"></a><span>              </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a><span> </span><a href="#local-6989586621679166310"><span class="hs-identifier hs-var">signed</span></a><span>
</span><a name="line-196"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier">initKESState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-type">KESState</span></a><span> </span><a href="#local-6989586621679166277"><span class="hs-identifier hs-type">era</span></a><span>
</span><a name="line-199"></a><span>    </span><a name="local-6989586621679166295"><a href="#local-6989586621679166295"><span class="hs-identifier">initKESState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-var">KESState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-identifier">kesStateInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-var">KESInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-201"></a><span>            </span><span class="hs-identifier">kesStartPeriod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679166292"><span class="hs-identifier hs-var">startPeriod</span></a><span>
</span><a name="line-202"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kesEndPeriod</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-var">Absolute.KESPeriod</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166293"><span class="hs-identifier hs-var">start</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679166294"><span class="hs-identifier hs-var">maxKESEvolutions</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>            </span><span class="hs-comment">-- We always start from 0 as the key hasn't evolved yet.</span><span>
</span><a name="line-204"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kesEvolution</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-205"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kesStateKey</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-var">KESKey</span></a><span> </span><a href="#local-6989586621679166291"><span class="hs-identifier hs-var">initKey</span></a><span>
</span><a name="line-207"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-comment">-- | Evolve the 'HotKey' so that its evolution matches the given KES period.</span><span>
</span><a name="line-210"></a><span class="hs-comment">--</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- When the given KES period is after the end period of the 'HotKey', we</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- poison the key and return 'UpdateFailed'.</span><span>
</span><a name="line-213"></a><span class="hs-comment">--</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- When the given KES period is before the start period of the 'HotKey' or</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- when the given period is before the key's period, we don't evolve the key</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- and return 'Unchanged'.</span><span>
</span><a name="line-217"></a><span class="hs-comment">--</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- When the given KES period is within the range of the 'HotKey' and the given</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- period is after the key's period, we evolve the key and return 'Updated'.</span><span>
</span><a name="line-220"></a><span class="hs-comment">--</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- When the key is poisoned, we always return 'UpdateFailed'.</span><span>
</span><a name="line-222"></a><span class="hs-identifier">evolveKey</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-223"></a><span>     </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679166244"><a href="#local-6989586621679166244"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679166245"><a href="#local-6989586621679166245"><span class="hs-identifier">era</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Cardano.Ledger.Era.html#Era"><span class="hs-identifier hs-type">Era</span></a><span> </span><a href="#local-6989586621679166245"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679166244"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#StrictMVar"><span class="hs-identifier hs-type">StrictMVar</span></a><span> </span><a href="#local-6989586621679166244"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-type">KESState</span></a><span> </span><a href="#local-6989586621679166245"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.OCert.html#KESPeriod"><span class="hs-identifier hs-type">Absolute.KESPeriod</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166244"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolutionInfo"><span class="hs-identifier hs-type">KESEvolutionInfo</span></a><span>
</span><a name="line-225"></a><a name="evolveKey"><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#evolveKey"><span class="hs-identifier">evolveKey</span></a></a><span> </span><a name="local-6989586621679166414"><a href="#local-6989586621679166414"><span class="hs-identifier">varKESState</span></a></a><span> </span><a name="local-6989586621679166415"><a href="#local-6989586621679166415"><span class="hs-identifier">targetPeriod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#modifyMVar"><span class="hs-identifier hs-var">modifyMVar</span></a><span> </span><a href="#local-6989586621679166414"><span class="hs-identifier hs-var">varKESState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679166425"><a href="#local-6989586621679166425"><span class="hs-identifier">kesState</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679166426"><a href="#local-6989586621679166426"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">kesStateInfo</span><span> </span><a href="#local-6989586621679166425"><span class="hs-identifier hs-var">kesState</span></a><span>
</span><a name="line-227"></a><span>    </span><span class="hs-comment">-- We mask the evolution process because if we got interrupted after</span><span>
</span><a name="line-228"></a><span>    </span><span class="hs-comment">-- calling 'forgetSignKeyKES', which destructively updates the current</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-comment">-- signing key, we would leave an erased key in the state, which might</span><span>
</span><a name="line-230"></a><span>    </span><span class="hs-comment">-- cause a segfault when used afterwards.</span><span>
</span><a name="line-231"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#uninterruptibleMask_"><span class="hs-identifier hs-var">uninterruptibleMask_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">kesStateKey</span><span> </span><a href="#local-6989586621679166425"><span class="hs-identifier hs-var">kesState</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span>      </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyPoisoned"><span class="hs-identifier hs-var">KESKeyPoisoned</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679166427"><a href="#local-6989586621679166427"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyAlreadyPoisoned"><span class="hs-identifier hs-var">KESKeyAlreadyPoisoned</span></a><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679166415"><span class="hs-identifier hs-var">targetPeriod</span></a><span>
</span><a name="line-235"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166425"><span class="hs-identifier hs-var">kesState</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#UpdateFailed"><span class="hs-identifier hs-var">UpdateFailed</span></a><span> </span><a href="#local-6989586621679166427"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>      </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-var">KESKey</span></a><span> </span><a name="local-6989586621679166428"><a href="#local-6989586621679166428"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#kesStatus"><span class="hs-identifier hs-var">kesStatus</span></a><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679166415"><span class="hs-identifier hs-var">targetPeriod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-238"></a><span>        </span><span class="hs-comment">-- When the absolute period is before the start period, we can't</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-comment">-- update the key. 'checkCanForge' will say we can't forge because the</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-comment">-- key is not valid yet.</span><span>
</span><a name="line-241"></a><span>        </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#BeforeKESStart"><span class="hs-identifier hs-var">BeforeKESStart</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-242"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166425"><span class="hs-identifier hs-var">kesState</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#Unchanged"><span class="hs-identifier hs-var">Unchanged</span></a><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- When the absolute period is after the end period, we can't evolve</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">-- anymore and poison the expired key.</span><span>
</span><a name="line-246"></a><span>        </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#AfterKESEnd"><span class="hs-identifier hs-var">AfterKESEnd</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-247"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679166429"><a href="#local-6989586621679166429"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESCouldNotEvolve"><span class="hs-identifier hs-var">KESCouldNotEvolve</span></a><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679166415"><span class="hs-identifier hs-var">targetPeriod</span></a><span>
</span><a name="line-248"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166416"><span class="hs-identifier hs-var">poisonState</span></a><span> </span><a href="#local-6989586621679166425"><span class="hs-identifier hs-var">kesState</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#UpdateFailed"><span class="hs-identifier hs-var">UpdateFailed</span></a><span> </span><a href="#local-6989586621679166429"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>        </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#InKESRange"><span class="hs-identifier hs-var">InKESRange</span></a><span> </span><a name="local-6989586621679166430"><a href="#local-6989586621679166430"><span class="hs-identifier">targetEvolution</span></a></a><span>
</span><a name="line-251"></a><span>          </span><span class="hs-comment">-- No evolving needed</span><span>
</span><a name="line-252"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679166430"><span class="hs-identifier hs-var">targetEvolution</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier">kesEvolution</span><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-253"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166425"><span class="hs-identifier hs-var">kesState</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#Unchanged"><span class="hs-identifier hs-var">Unchanged</span></a><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span>          </span><span class="hs-comment">-- Evolving needed</span><span>
</span><a name="line-256"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-257"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679166431"><a href="#local-6989586621679166431"><span class="hs-identifier">s'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679166431"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Block.Forging.html#Updated"><span class="hs-identifier hs-var">Updated</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">kesStateInfo</span><span> </span><a href="#local-6989586621679166431"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-258"></a><span>               </span><a href="#local-6989586621679166417"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679166430"><span class="hs-identifier hs-var">targetEvolution</span></a><span> </span><a href="#local-6989586621679166426"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679166428"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-identifier">poisonState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-type">KESState</span></a><span> </span><a href="#local-6989586621679166245"><span class="hs-identifier hs-type">era</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-type">KESState</span></a><span> </span><a href="#local-6989586621679166245"><span class="hs-identifier hs-type">era</span></a><span>
</span><a name="line-262"></a><span>    </span><a name="local-6989586621679166416"><a href="#local-6989586621679166416"><span class="hs-identifier">poisonState</span></a></a><span> </span><a name="local-6989586621679166418"><a href="#local-6989586621679166418"><span class="hs-identifier">kesState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679166418"><span class="hs-identifier hs-var">kesState</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">kesStateKey</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKeyPoisoned"><span class="hs-identifier hs-var">KESKeyPoisoned</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span>    </span><span class="hs-comment">-- | PRECONDITION:</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-comment">-- &gt; targetEvolution &gt;= curEvolution</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESEvolution"><span class="hs-identifier hs-type">KESEvolution</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESInfo"><span class="hs-identifier hs-type">KESInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/shelley-spec-ledger-0.1.0.0/noopt/doc/html/shelley-spec-ledger/src/Shelley.Spec.Ledger.Keys.html#SignKeyKES"><span class="hs-identifier hs-type">SL.SignKeyKES</span></a><span> </span><a href="#local-6989586621679166245"><span class="hs-identifier hs-type">era</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679166244"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-type">KESState</span></a><span> </span><a href="#local-6989586621679166245"><span class="hs-identifier hs-type">era</span></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>    </span><a name="local-6989586621679166417"><a href="#local-6989586621679166417"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679166419"><a href="#local-6989586621679166419"><span class="hs-identifier">targetEvolution</span></a></a><span> </span><a name="local-6989586621679166420"><a href="#local-6989586621679166420"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621679166421"><a href="#local-6989586621679166421"><span class="hs-identifier">key</span></a></a><span>
</span><a name="line-269"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679166419"><span class="hs-identifier hs-var">targetEvolution</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679166422"><span class="hs-identifier hs-var">curEvolution</span></a><span>
</span><a name="line-270"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESState"><span class="hs-identifier hs-var">KESState</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">kesStateInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679166420"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">kesStateKey</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Shelley.Protocol.HotKey.html#KESKey"><span class="hs-identifier hs-var">KESKey</span></a><span> </span><a href="#local-6989586621679166421"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-271"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-272"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-crypto-class-2.0.0/noopt/doc/html/cardano-crypto-class/src/Cardano.Crypto.KES.Class.html#updateKES"><span class="hs-identifier hs-var">SL.updateKES</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679166421"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679166422"><span class="hs-identifier hs-var">curEvolution</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-273"></a><span>          </span><span class="hs-comment">-- This cannot happen</span><span>
</span><a name="line-274"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Could not update KES key&quot;</span><span>
</span><a name="line-275"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679166423"><a href="#local-6989586621679166423"><span class="hs-identifier">key'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-276"></a><span>            </span><span class="hs-comment">-- Clear the memory associated with the old key</span><span>
</span><a name="line-277"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src/Ouroboros.Consensus.Util.IOLike.html#forgetSignKeyKES"><span class="hs-identifier hs-var">forgetSignKeyKES</span></a><span> </span><a href="#local-6989586621679166421"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-278"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679166424"><a href="#local-6989586621679166424"><span class="hs-identifier">info'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679166420"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">kesEvolution</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679166422"><span class="hs-identifier hs-var">curEvolution</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-279"></a><span>            </span><a href="#local-6989586621679166417"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679166419"><span class="hs-identifier hs-var">targetEvolution</span></a><span> </span><a href="#local-6989586621679166424"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621679166423"><span class="hs-identifier hs-var">key'</span></a><span>
</span><a name="line-280"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-281"></a><span>        </span><a name="local-6989586621679166422"><a href="#local-6989586621679166422"><span class="hs-identifier">curEvolution</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">kesEvolution</span><span> </span><a href="#local-6989586621679166420"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-282"></a></pre></body></html>