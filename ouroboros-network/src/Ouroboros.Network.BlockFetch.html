<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-comment">{-| Let's start with the big picture...

@
Key:  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;   &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
      &#9475; STM-based  &#9475;  &#9553;active thread&#9553;  &#9475;state instance&#9475;&#9491;  &#9553; one thread &#9553;&#9559;
      &#9475;shared state&#9475;  &#9553;             &#9553;  &#9475;   per peer   &#9475;&#9475;  &#9553;  per peer  &#9553;&#9553;
      &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9475;  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
                                        &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;   &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
@

@
  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;     &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;
  &#9553; Chain sync  &#9553;&#9559;    &#9475;   Ledger    &#9475;
  &#9553;  protocol   &#9553;&#9553;&#9664;&#9472;&#9472;&#9472;&#9512;   state     &#9475;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9582;
  &#9553;(client side)&#9553;&#9553;    &#9475;             &#9475;            &#9474;
  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;    &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;            &#9474;
   &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9578;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;                               &#9474;
         &#9660;                                       &#9474;
  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
  &#9475;  Candidate  &#9475;     &#9475;   Set of    &#9475;     &#9553;  Chain and  &#9553;
  &#9475;  chains     &#9475;     &#9475;  downloaded &#9504;&#9472;&#9472;&#9472;&#9472;&#9654;&#9553;   ledger    &#9553;
  &#9475;  (headers)  &#9475;     &#9475;   blocks    &#9475;     &#9553;  validation &#9553;
  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9519;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;     &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9519;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;     &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
        &#9474;                   &#9474; &#9650;                  &#9474;
        &#9474; &#9581;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9583; &#9474;                  &#9474;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9660;&#9617;&#9660;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;           &#9474;                  &#9660;
&#9617;&#9617;&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;&#9617;&#9617;           &#9474;           &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9617;&#9617;&#9553;    Block    &#9553;&#9617;&#9617;           &#9474;           &#9475;   Current   &#9475;     &#9553; Block fetch &#9553;&#9559;
&#9617;&#9617;&#9570;    fetch    &#9553;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9512;    chain    &#9504;&#9472;&#9472;&#9472;&#9472;&#9654;&#9553; protocol    &#9553;&#9553;
&#9617;&#9617;&#9553;    logic    &#9553;&#9617;&#9617;           &#9474;           &#9475;  (blocks)   &#9475;     &#9553;(server side)&#9553;&#9553;
&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9617;&#9617;           &#9474;           &#9504;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9512;     &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9650;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;           &#9474;           &#9475;  Tentative  &#9475;      &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9660;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9474;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;   &#9475;    chain    &#9504;&#9472;&#9472;&#9582;
&#9617;&#9617;&#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;&#9617;&#9617;&#9617;&#9617;&#9617;&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;&#9617;&#9617;   &#9475;  (headers)  &#9475;  &#9474;  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9617;&#9617;&#9475; Block fetch &#9475;&#9491;&#9617;&#9617;&#9617;&#9617;&#9553; block fetch &#9553;&#9559;&#9617;   &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;  &#9474;  &#9553; Chain sync  &#9553;&#9559;
&#9617;&#9617;&#9475;  state and  &#9475;&#9475;&#9664;&#9472;&#9472;&#9654;&#9553;  protocol   &#9553;&#9553;&#9617;                    &#9584;&#9472;&#9654;&#9553; protocol    &#9553;&#9553;
&#9617;&#9617;&#9475;  requests   &#9475;&#9475;&#9617;&#9617;&#9617;&#9617;&#9553;(client side)&#9553;&#9553;&#9617;                       &#9553;(server side)&#9553;&#9553;
&#9617;&#9617;&#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9475;&#9617;&#9617;&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;&#9617;                       &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
&#9617;&#9617;&#9617;&#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9617;&#9617;&#9617;&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9617;                        &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;
@
Notes:

 * Thread communication is via STM based state.
 * Outbound: threads update STM state.
 * Inbound: threads wait on STM state changing (using retry).
 * These are no queues: there is only the current state, not all change events.

We consider the block fetch logic and the policy for the block fetch protocol
client together as one unit of functionality. This is the shaded area in the
diagram.

Looking at the diagram we see that these two threads interact with each other
and other threads via the following shared state

+-----------------------------+----------------+--------------------+
|  State                      |  Interactions  | Internal\/External |
+=============================+================+====================+
|  Candidate chains (headers) |  Read          |  External          |
+-----------------------------+----------------+--------------------+
|  Current chain (blocks)     |  Read          |  External          |
+-----------------------------+----------------+--------------------+
|  Set of downloaded blocks   |  Read &amp; Write  |  External          |
+-----------------------------+----------------+--------------------+
|  Block fetch requests       |  Read &amp; Write  |  Internal          |
+-----------------------------+----------------+--------------------+

The block fetch requests state is private between the block fetch logic
and the block fetch protocol client, so it is implemented here.

The other state is managed by the consensus layer and is considered external
here. So here we define interfaces for interacting with the external state.
These have to be provided when instantiating the block fetch logic.

-}</span><span>
</span><a name="line-81"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.BlockFetch</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-82"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier hs-var">blockFetchLogic</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-comment">-- ** Tracer types</span><span>
</span><a name="line-86"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceLabelPeer"><span class="hs-identifier hs-type">TraceLabelPeer</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-comment">-- * The 'FetchClientRegistry'</span><span>
</span><a name="line-91"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier hs-type">FetchClientRegistry</span></a><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#newFetchClientRegistry"><span class="hs-identifier hs-var">newFetchClientRegistry</span></a><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketFetchClient"><span class="hs-identifier hs-var">bracketFetchClient</span></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketSyncWithFetchClient"><span class="hs-identifier hs-var">bracketSyncWithFetchClient</span></a><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketKeepAliveClient"><span class="hs-identifier hs-var">bracketKeepAliveClient</span></a><span class="hs-special">,</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-comment">-- * Re-export types used by 'BlockFetchConsensusInterface'</span><span>
</span><a name="line-98"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>    </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Hashable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Void</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html"><span class="hs-identifier">Control.Tracer</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.Block.html"><span class="hs-identifier">Ouroboros.Network.Block</span></a><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.DeltaQ.html"><span class="hs-identifier">Ouroboros.Network.DeltaQ</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.BlockFetch.State.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.State</span></a><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientRegistry</span></a><span>
</span><a name="line-117"></a><span>                   </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-type">FetchClientPolicy</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier hs-type">FetchClientRegistry</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#newFetchClientRegistry"><span class="hs-identifier hs-var">newFetchClientRegistry</span></a><span>
</span><a name="line-119"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStatus"><span class="hs-identifier hs-var">readFetchClientsStatus</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStateVars"><span class="hs-identifier hs-var">readFetchClientsStateVars</span></a><span>
</span><a name="line-120"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readPeerGSVs"><span class="hs-identifier hs-var">readPeerGSVs</span></a><span>
</span><a name="line-121"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketFetchClient"><span class="hs-identifier hs-var">bracketFetchClient</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketKeepAliveClient"><span class="hs-identifier hs-var">bracketKeepAliveClient</span></a><span>
</span><a name="line-122"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketSyncWithFetchClient"><span class="hs-identifier hs-var">bracketSyncWithFetchClient</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#setFetchClientContext"><span class="hs-identifier hs-var">setFetchClientContext</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- | The consensus layer functionality that the block fetch logic requires.</span><span>
</span><a name="line-126"></a><span class="hs-comment">--</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- These are provided as input to the block fetch by the consensus layer.</span><span>
</span><a name="line-128"></a><span class="hs-comment">--</span><span>
</span><a name="line-129"></a><span class="hs-keyword">data</span><span> </span><a name="BlockFetchConsensusInterface"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier">BlockFetchConsensusInterface</span></a></a><span> </span><a name="local-6989586621679194894"><a href="#local-6989586621679194894"><span class="hs-identifier">peer</span></a></a><span> </span><a name="local-6989586621679194895"><a href="#local-6989586621679194895"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621679194896"><a href="#local-6989586621679194896"><span class="hs-identifier">block</span></a></a><span> </span><a name="local-6989586621679194897"><a href="#local-6989586621679194897"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>     </span><a name="BlockFetchConsensusInterface"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier">BlockFetchConsensusInterface</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span>       </span><span class="hs-comment">-- | Read the K-suffixes of the candidate chains.</span><span>
</span><a name="line-133"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-134"></a><span>       </span><span class="hs-comment">-- Assumptions:</span><span>
</span><a name="line-135"></a><span>       </span><span class="hs-comment">-- * They must be already validated.</span><span>
</span><a name="line-136"></a><span>       </span><span class="hs-comment">-- * They may contain /fewer/ than @K@ blocks.</span><span>
</span><a name="line-137"></a><span>       </span><span class="hs-comment">-- * Their anchor does not have to intersect with the current chain.</span><span>
</span><a name="line-138"></a><span>       </span><a name="readCandidateChains"><a href="Ouroboros.Network.BlockFetch.html#readCandidateChains"><span class="hs-identifier">readCandidateChains</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679194897"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679194894"><span class="hs-identifier hs-type">peer</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>       </span><span class="hs-comment">-- | Read the K-suffix of the current chain.</span><span>
</span><a name="line-141"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span>       </span><span class="hs-comment">-- This must contain info on the last @K@ blocks (unless we're near</span><span>
</span><a name="line-143"></a><span>       </span><span class="hs-comment">-- the chain genesis of course).</span><span>
</span><a name="line-144"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span>       </span><a name="readCurrentChain"><a href="Ouroboros.Network.BlockFetch.html#readCurrentChain"><span class="hs-identifier">readCurrentChain</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679194897"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>       </span><span class="hs-comment">-- | Read the current fetch mode that the block fetch logic should use.</span><span>
</span><a name="line-148"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-149"></a><span>       </span><span class="hs-comment">-- The fetch mode is a dynamic part of the block fetch policy. In</span><span>
</span><a name="line-150"></a><span>       </span><span class="hs-comment">-- 'FetchModeBulkSync' it follows a policy that optimises for expected</span><span>
</span><a name="line-151"></a><span>       </span><span class="hs-comment">-- bandwidth over latency to fetch any particular block, whereas in</span><span>
</span><a name="line-152"></a><span>       </span><span class="hs-comment">-- 'FetchModeDeadline' it follows a policy optimises for the latency</span><span>
</span><a name="line-153"></a><span>       </span><span class="hs-comment">-- to fetch blocks, at the expense of wasting bandwidth.</span><span>
</span><a name="line-154"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-155"></a><span>       </span><span class="hs-comment">-- This mode should be set so that when the node's current chain is near</span><span>
</span><a name="line-156"></a><span>       </span><span class="hs-comment">-- to \&quot;now\&quot; it uses the deadline mode, and when it is far away it uses</span><span>
</span><a name="line-157"></a><span>       </span><span class="hs-comment">-- the bulk sync mode.</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-159"></a><span>       </span><a name="readFetchMode"><a href="Ouroboros.Network.BlockFetch.html#readFetchMode"><span class="hs-identifier">readFetchMode</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679194897"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span class="hs-special">,</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span>       </span><span class="hs-comment">-- | Recent, only within last K</span><span>
</span><a name="line-162"></a><span>       </span><a name="readFetchedBlocks"><a href="Ouroboros.Network.BlockFetch.html#readFetchedBlocks"><span class="hs-identifier">readFetchedBlocks</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679194897"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a><span> </span><a href="#local-6989586621679194896"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span>       </span><span class="hs-comment">-- | This and 'readFetchedBlocks' are required to be linked. Upon</span><span>
</span><a name="line-165"></a><span>       </span><span class="hs-comment">-- successful completion of 'addFetchedBlock' it must be the case that</span><span>
</span><a name="line-166"></a><span>       </span><span class="hs-comment">-- 'readFetchedBlocks' reports the block.</span><span>
</span><a name="line-167"></a><span>       </span><a name="addFetchedBlock"><a href="Ouroboros.Network.BlockFetch.html#addFetchedBlock"><span class="hs-identifier">addFetchedBlock</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a><span> </span><a href="#local-6989586621679194896"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679194896"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679194897"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span>       </span><span class="hs-comment">-- | The highest stored/downloaded slot number.</span><span>
</span><a name="line-170"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span>       </span><span class="hs-comment">-- This is used to optimise the filtering of fragments in the block</span><span>
</span><a name="line-172"></a><span>       </span><span class="hs-comment">-- fetch logic: when removing already downloaded blocks from a</span><span>
</span><a name="line-173"></a><span>       </span><span class="hs-comment">-- fragment, the filtering (with a linear cost) is stopped as soon as a</span><span>
</span><a name="line-174"></a><span>       </span><span class="hs-comment">-- block has a slot number higher than this slot number, as it cannot</span><span>
</span><a name="line-175"></a><span>       </span><span class="hs-comment">-- have been downloaded anyway.</span><span>
</span><a name="line-176"></a><span>       </span><a name="readFetchedMaxSlotNo"><a href="Ouroboros.Network.BlockFetch.html#readFetchedMaxSlotNo"><span class="hs-identifier">readFetchedMaxSlotNo</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679194897"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span class="hs-special">,</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>       </span><span class="hs-comment">-- | Given the current chain, is the given chain plausible as a</span><span>
</span><a name="line-179"></a><span>       </span><span class="hs-comment">-- candidate chain. Classically for Ouroboros this would simply</span><span>
</span><a name="line-180"></a><span>       </span><span class="hs-comment">-- check if the candidate is strictly longer, but for Ouroboros</span><span>
</span><a name="line-181"></a><span>       </span><span class="hs-comment">-- with operational key certificates there are also cases where</span><span>
</span><a name="line-182"></a><span>       </span><span class="hs-comment">-- we would consider a chain of equal length to the current chain.</span><span>
</span><a name="line-183"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-184"></a><span>       </span><a name="plausibleCandidateChain"><a href="Ouroboros.Network.BlockFetch.html#plausibleCandidateChain"><span class="hs-identifier">plausibleCandidateChain</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-185"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>       </span><span class="hs-comment">-- | Compare two candidate chains and return a preference ordering.</span><span>
</span><a name="line-188"></a><span>       </span><span class="hs-comment">-- This is used as part of selecting which chains to prioritise for</span><span>
</span><a name="line-189"></a><span>       </span><span class="hs-comment">-- downloading block bodies.</span><span>
</span><a name="line-190"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-191"></a><span>       </span><a name="compareCandidateChains"><a href="Ouroboros.Network.BlockFetch.html#compareCandidateChains"><span class="hs-identifier">compareCandidateChains</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-192"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-193"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span class="hs-special">,</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>       </span><span class="hs-comment">-- | Much of the logic for deciding which blocks to download from which</span><span>
</span><a name="line-196"></a><span>       </span><span class="hs-comment">-- peer depends on making estimates based on recent performance metrics.</span><span>
</span><a name="line-197"></a><span>       </span><span class="hs-comment">-- These estimates of course depend on the amount of data we will be</span><span>
</span><a name="line-198"></a><span>       </span><span class="hs-comment">-- downloading.</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span>       </span><a name="blockFetchSize"><a href="Ouroboros.Network.BlockFetch.html#blockFetchSize"><span class="hs-identifier">blockFetchSize</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>       </span><span class="hs-comment">-- | Given a block header, validate the supposed corresponding block</span><span>
</span><a name="line-203"></a><span>       </span><span class="hs-comment">-- body.</span><span>
</span><a name="line-204"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-205"></a><span>       </span><a name="blockMatchesHeader"><a href="Ouroboros.Network.BlockFetch.html#blockMatchesHeader"><span class="hs-identifier">blockMatchesHeader</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679194895"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679194896"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-206"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- | Configuration for FetchDecisionPolicy.</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- Should be determined by external local node config.</span><span>
</span><a name="line-210"></a><span class="hs-keyword">data</span><span> </span><a name="BlockFetchConfiguration"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier">BlockFetchConfiguration</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-211"></a><span>     </span><a name="BlockFetchConfiguration"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier">BlockFetchConfiguration</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-212"></a><span>         </span><span class="hs-comment">-- | Maximum concurrent downloads during bulk syncing.</span><span>
</span><a name="line-213"></a><span>         </span><a name="bfcMaxConcurrencyBulkSync"><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyBulkSync"><span class="hs-identifier">bfcMaxConcurrencyBulkSync</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>         </span><span class="hs-comment">-- | Maximum concurrent downloads during deadline syncing.</span><span>
</span><a name="line-216"></a><span>         </span><a name="bfcMaxConcurrencyDeadline"><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyDeadline"><span class="hs-identifier">bfcMaxConcurrencyDeadline</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>         </span><span class="hs-comment">-- | Maximum requests in flight per each peer.</span><span>
</span><a name="line-219"></a><span>         </span><a name="bfcMaxRequestsInflight"><a href="Ouroboros.Network.BlockFetch.html#bfcMaxRequestsInflight"><span class="hs-identifier">bfcMaxRequestsInflight</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>         </span><span class="hs-comment">-- | Desired intervall between calls to fetchLogicIteration</span><span>
</span><a name="line-222"></a><span>         </span><a name="bfcDecisionLoopInterval"><a href="Ouroboros.Network.BlockFetch.html#bfcDecisionLoopInterval"><span class="hs-identifier">bfcDecisionLoopInterval</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">,</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>         </span><span class="hs-comment">-- | Salt used when comparing peers</span><span>
</span><a name="line-225"></a><span>         </span><a name="bfcSalt"><a href="Ouroboros.Network.BlockFetch.html#bfcSalt"><span class="hs-identifier">bfcSalt</span></a></a><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-226"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- | Execute the block fetch logic. It monitors the current chain and candidate</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- chains. It decided which block bodies to fetch and manages the process of</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- fetching them, including making alternative decisions based on timeouts and</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- failures.</span><span>
</span><a name="line-232"></a><span class="hs-comment">--</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- This runs forever and should be shut down using mechanisms such as async.</span><span>
</span><a name="line-234"></a><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span class="hs-identifier">blockFetchLogic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679194898"><a href="#local-6989586621679194898"><span class="hs-identifier">peer</span></a></a><span> </span><a name="local-6989586621679194899"><a href="#local-6989586621679194899"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621679194900"><a href="#local-6989586621679194900"><span class="hs-identifier">block</span></a></a><span> </span><a name="local-6989586621679194901"><a href="#local-6989586621679194901"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-236"></a><span>                   </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-237"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679194900"><span class="hs-identifier hs-type">block</span></a><span>
</span><a name="line-238"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">~</span><span> </span><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679194900"><span class="hs-identifier hs-type">block</span></a><span>
</span><a name="line-239"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadDelay"><span class="hs-identifier hs-type">MonadDelay</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-240"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#MonadMonotonicTime"><span class="hs-identifier hs-type">MonadMonotonicTime</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-241"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-242"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span>
</span><a name="line-243"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span>
</span><a name="line-244"></a><span>                   </span><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceLabelPeer"><span class="hs-identifier hs-type">TraceLabelPeer</span></a><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-246"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceLabelPeer"><span class="hs-identifier hs-type">TraceLabelPeer</span></a><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></a><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679194900"><span class="hs-identifier hs-type">block</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-248"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier hs-type">FetchClientRegistry</span></a><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679194900"><span class="hs-identifier hs-type">block</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-249"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a><span>
</span><a name="line-250"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Void</span><span>
</span><a name="line-251"></a><a name="blockFetchLogic"><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier">blockFetchLogic</span></a></a><span> </span><a name="local-6989586621679194902"><a href="#local-6989586621679194902"><span class="hs-identifier">decisionTracer</span></a></a><span> </span><a name="local-6989586621679194903"><a href="#local-6989586621679194903"><span class="hs-identifier">clientStateTracer</span></a></a><span>
</span><a name="line-252"></a><span>                </span><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-var">BlockFetchConsensusInterface</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-253"></a><span>                </span><a name="local-6989586621679194914"><a href="#local-6989586621679194914"><span class="hs-identifier">registry</span></a></a><span>
</span><a name="line-254"></a><span>                </span><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-var">BlockFetchConfiguration</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#setFetchClientContext"><span class="hs-identifier hs-var">setFetchClientContext</span></a><span> </span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">registry</span></a><span> </span><a href="#local-6989586621679194903"><span class="hs-identifier hs-var">clientStateTracer</span></a><span> </span><a href="#local-6989586621679194920"><span class="hs-identifier hs-var">fetchClientPolicy</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterations"><span class="hs-identifier hs-var">fetchLogicIterations</span></a><span>
</span><a name="line-259"></a><span>      </span><a href="#local-6989586621679194902"><span class="hs-identifier hs-var">decisionTracer</span></a><span> </span><a href="#local-6989586621679194903"><span class="hs-identifier hs-var">clientStateTracer</span></a><span>
</span><a name="line-260"></a><span>      </span><a href="#local-6989586621679194921"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a><span>
</span><a name="line-261"></a><span>      </span><a href="#local-6989586621679194922"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a><span>
</span><a name="line-262"></a><span>      </span><a href="#local-6989586621679194923"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-identifier">fetchClientPolicy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-type">FetchClientPolicy</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679194900"><span class="hs-identifier hs-type">block</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621679194920"><a href="#local-6989586621679194920"><span class="hs-identifier">fetchClientPolicy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-var">FetchClientPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-266"></a><span>                          </span><a href="#local-6989586621679194912"><span class="hs-identifier hs-var">blockFetchSize</span></a><span class="hs-special">,</span><span>
</span><a name="line-267"></a><span>                          </span><a href="#local-6989586621679194913"><span class="hs-identifier hs-var">blockMatchesHeader</span></a><span class="hs-special">,</span><span>
</span><a name="line-268"></a><span>                          </span><a href="#local-6989586621679194908"><span class="hs-identifier hs-var">addFetchedBlock</span></a><span>
</span><a name="line-269"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>    </span><span class="hs-identifier">fetchDecisionPolicy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-272"></a><span>    </span><a name="local-6989586621679194921"><a href="#local-6989586621679194921"><span class="hs-identifier">fetchDecisionPolicy</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-273"></a><span>      </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-var">FetchDecisionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-274"></a><span>        </span><span class="hs-identifier">maxInFlightReqsPerPeer</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194917"><span class="hs-identifier hs-var">bfcMaxRequestsInflight</span></a><span class="hs-special">,</span><span>
</span><a name="line-275"></a><span>        </span><span class="hs-identifier">maxConcurrencyBulkSync</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194915"><span class="hs-identifier hs-var">bfcMaxConcurrencyBulkSync</span></a><span class="hs-special">,</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-identifier">maxConcurrencyDeadline</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194916"><span class="hs-identifier hs-var">bfcMaxConcurrencyDeadline</span></a><span class="hs-special">,</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-identifier">decisionLoopInterval</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194918"><span class="hs-identifier hs-var">bfcDecisionLoopInterval</span></a><span class="hs-special">,</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-identifier">peerSalt</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194919"><span class="hs-identifier hs-var">bfcSalt</span></a><span class="hs-special">,</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span>        </span><a href="#local-6989586621679194910"><span class="hs-identifier hs-var">plausibleCandidateChain</span></a><span class="hs-special">,</span><span>
</span><a name="line-281"></a><span>        </span><a href="#local-6989586621679194911"><span class="hs-identifier hs-var">compareCandidateChains</span></a><span class="hs-special">,</span><span>
</span><a name="line-282"></a><span>        </span><a href="#local-6989586621679194912"><span class="hs-identifier hs-var">blockFetchSize</span></a><span>
</span><a name="line-283"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>    </span><span class="hs-identifier">fetchTriggerVariables</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-286"></a><span>    </span><a name="local-6989586621679194922"><a href="#local-6989586621679194922"><span class="hs-identifier">fetchTriggerVariables</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-287"></a><span>      </span><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-var">FetchTriggerVariables</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-288"></a><span>        </span><span class="hs-identifier">readStateCurrentChain</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194905"><span class="hs-identifier hs-var">readCurrentChain</span></a><span class="hs-special">,</span><span>
</span><a name="line-289"></a><span>        </span><span class="hs-identifier">readStateCandidateChains</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194904"><span class="hs-identifier hs-var">readCandidateChains</span></a><span class="hs-special">,</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-identifier">readStatePeerStatus</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStatus"><span class="hs-identifier hs-var">readFetchClientsStatus</span></a><span> </span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">registry</span></a><span>
</span><a name="line-291"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span>    </span><span class="hs-identifier">fetchNonTriggerVariables</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a><span> </span><a href="#local-6989586621679194898"><span class="hs-identifier hs-type">peer</span></a><span> </span><a href="#local-6989586621679194899"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679194900"><span class="hs-identifier hs-type">block</span></a><span> </span><a href="#local-6989586621679194901"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621679194923"><a href="#local-6989586621679194923"><span class="hs-identifier">fetchNonTriggerVariables</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-295"></a><span>      </span><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-var">FetchNonTriggerVariables</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-identifier">readStateFetchedBlocks</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194907"><span class="hs-identifier hs-var">readFetchedBlocks</span></a><span class="hs-special">,</span><span>
</span><a name="line-297"></a><span>        </span><span class="hs-identifier">readStatePeerStateVars</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStateVars"><span class="hs-identifier hs-var">readFetchClientsStateVars</span></a><span> </span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">registry</span></a><span class="hs-special">,</span><span>
</span><a name="line-298"></a><span>        </span><span class="hs-identifier">readStatePeerGSVs</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readPeerGSVs"><span class="hs-identifier hs-var">readPeerGSVs</span></a><span> </span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">registry</span></a><span class="hs-special">,</span><span>
</span><a name="line-299"></a><span>        </span><span class="hs-identifier">readStateFetchMode</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194906"><span class="hs-identifier hs-var">readFetchMode</span></a><span class="hs-special">,</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-identifier">readStateFetchedMaxSlotNo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679194909"><span class="hs-identifier hs-var">readFetchedMaxSlotNo</span></a><span>
</span><a name="line-301"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-302"></a></pre></body></html>