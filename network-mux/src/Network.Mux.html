<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns              #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DataKinds                 #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts          #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GADTSyntax                #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures            #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns            #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables       #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies              #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.Mux</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-comment">-- * Defining 'Mux' protocol bundles</span><span>
</span><a name="line-15"></a><span>      </span><a href="Network.Mux.html#newMux"><span class="hs-identifier hs-var">newMux</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-type">Mux</span></a><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MuxMode"><span class="hs-identifier hs-type">MuxMode</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#HasInitiator"><span class="hs-identifier hs-type">HasInitiator</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#HasResponder"><span class="hs-identifier hs-type">HasResponder</span></a><span>
</span><a name="line-20"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolBundle"><span class="hs-identifier hs-type">MiniProtocolBundle</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-type">MiniProtocolInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolDirection"><span class="hs-identifier hs-type">MiniProtocolDirection</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolLimits"><span class="hs-identifier hs-type">MiniProtocolLimits</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>      </span><span class="hs-comment">-- * Running the Mux</span><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#runMux"><span class="hs-identifier hs-var">runMux</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MuxBearer"><span class="hs-identifier hs-type">MuxBearer</span></a><span>
</span><a name="line-29"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#runMiniProtocol"><span class="hs-identifier hs-var">runMiniProtocol</span></a><span>
</span><a name="line-30"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#StartOnDemandOrEagerly"><span class="hs-identifier hs-type">StartOnDemandOrEagerly</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#stopMux"><span class="hs-identifier hs-var">stopMux</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span>      </span><span class="hs-comment">-- * Errors</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Trace.html#MuxError"><span class="hs-identifier hs-type">MuxError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Trace.html#MuxErrorType"><span class="hs-identifier hs-type">MuxErrorType</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>      </span><span class="hs-comment">-- * Tracing</span><span>
</span><a name="line-38"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#traceMuxBearerState"><span class="hs-identifier hs-var">traceMuxBearerState</span></a><span>
</span><a name="line-39"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Trace.html#MuxBearerState"><span class="hs-identifier hs-type">MuxBearerState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Trace.html#MuxTrace"><span class="hs-identifier hs-type">MuxTrace</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Network.Mux.Trace.html#WithMuxBearer"><span class="hs-identifier hs-type">WithMuxBearer</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BL</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Control.Concurrent.JobPool.html"><span class="hs-identifier">Control.Concurrent.JobPool</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">JobPool</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadFork.html"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html"><span class="hs-identifier">Control.Monad.Class.MonadSTM.Strict</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html"><span class="hs-identifier">Control.Tracer</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.Mux.Channel.html"><span class="hs-identifier">Network.Mux.Channel</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.Mux.Egress.html"><span class="hs-identifier">Network.Mux.Egress</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Egress</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.Mux.Ingress.html"><span class="hs-identifier">Network.Mux.Ingress</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Ingress</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.Mux.Trace.html"><span class="hs-identifier">Network.Mux.Trace</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.Mux.Types.html"><span class="hs-identifier">Network.Mux.Types</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">data</span><span> </span><a name="Mux"><a href="Network.Mux.html#Mux"><span class="hs-identifier">Mux</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679120928"><a href="#local-6989586621679120928"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Mux.Types.html#MuxMode"><span class="hs-identifier hs-type">MuxMode</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679120929"><a href="#local-6989586621679120929"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-68"></a><span>     </span><a name="Mux"><a href="Network.Mux.html#Mux"><span class="hs-identifier">Mux</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-69"></a><span>       </span><a name="muxMiniProtocols"><a href="Network.Mux.html#muxMiniProtocols"><span class="hs-identifier">muxMiniProtocols</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolDir"><span class="hs-identifier hs-type">MiniProtocolDir</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>                                   </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120928"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120929"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>       </span><a name="muxControlCmdQueue"><a href="Network.Mux.html#muxControlCmdQueue"><span class="hs-identifier">muxControlCmdQueue</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a><span> </span><a href="#local-6989586621679120929"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#ControlCmd"><span class="hs-identifier hs-type">ControlCmd</span></a><span> </span><a href="#local-6989586621679120928"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120929"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>       </span><a name="muxStatus"><a href="Network.Mux.html#muxStatus"><span class="hs-identifier">muxStatus</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679120929"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.html#MuxStatus"><span class="hs-identifier hs-type">MuxStatus</span></a><span>
</span><a name="line-73"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-keyword">data</span><span> </span><a name="MuxStatus"><a href="Network.Mux.html#MuxStatus"><span class="hs-identifier">MuxStatus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MuxReady"><a href="Network.Mux.html#MuxReady"><span class="hs-identifier">MuxReady</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="MuxFailed"><a href="Network.Mux.html#MuxFailed"><span class="hs-identifier">MuxFailed</span></a></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="MuxStopped"><a href="Network.Mux.html#MuxStopped"><span class="hs-identifier">MuxStopped</span></a></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">newMux</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120947"><span class="hs-identifier hs-type">m</span></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolBundle"><span class="hs-identifier hs-type">MiniProtocolBundle</span></a><span> </span><a href="#local-6989586621679120948"><span class="hs-identifier hs-type">mode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120947"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-type">Mux</span></a><span> </span><a href="#local-6989586621679120948"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120947"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><a name="newMux"><a href="Network.Mux.html#newMux"><span class="hs-identifier">newMux</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolBundle"><span class="hs-identifier hs-var">MiniProtocolBundle</span></a><span> </span><a name="local-6989586621679120949"><a href="#local-6989586621679120949"><span class="hs-identifier">ptcls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679120950"><a href="#local-6989586621679120950"><span class="hs-identifier">muxMiniProtocols</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Mux.html#mkMiniProtocolStateMap"><span class="hs-identifier hs-var">mkMiniProtocolStateMap</span></a><span> </span><a href="#local-6989586621679120949"><span class="hs-identifier hs-var">ptcls</span></a><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679120951"><a href="#local-6989586621679120951"><span class="hs-identifier">muxControlCmdQueue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#newTQueue"><span class="hs-identifier hs-var">newTQueue</span></a><span>
</span><a name="line-81"></a><span>    </span><a name="local-6989586621679120952"><a href="#local-6989586621679120952"><span class="hs-identifier">muxStatus</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newTVarM"><span class="hs-identifier hs-var">newTVarM</span></a><span> </span><a href="Network.Mux.html#MuxReady"><span class="hs-identifier hs-var">MuxReady</span></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-var">Mux</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-83"></a><span>      </span><a href="#local-6989586621679120950"><span class="hs-identifier hs-var">muxMiniProtocols</span></a><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>      </span><a href="#local-6989586621679120951"><span class="hs-identifier hs-var">muxControlCmdQueue</span></a><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>      </span><a href="#local-6989586621679120952"><span class="hs-identifier hs-var">muxStatus</span></a><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-identifier">mkMiniProtocolStateMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120945"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-89"></a><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-type">MiniProtocolInfo</span></a><span> </span><a href="#local-6989586621679120946"><span class="hs-identifier hs-type">mode</span></a><span class="hs-special">]</span><span>
</span><a name="line-90"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120945"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolDir"><span class="hs-identifier hs-type">MiniProtocolDir</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>                                 </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120946"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120945"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><a name="mkMiniProtocolStateMap"><a href="Network.Mux.html#mkMiniProtocolStateMap"><span class="hs-identifier">mkMiniProtocolStateMap</span></a></a><span> </span><a name="local-6989586621679120953"><a href="#local-6989586621679120953"><span class="hs-identifier">ptcls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-identifier hs-var">sequence</span><span>
</span><a name="line-95"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679121364"><a href="#local-6989586621679121364"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Mux.html#mkMiniProtocolState"><span class="hs-identifier hs-var">mkMiniProtocolState</span></a><span> </span><a href="#local-6989586621679121361"><span class="hs-identifier hs-var">ptcl</span></a><span>
</span><a name="line-96"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679121362"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121363"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679121364"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679121361"><a href="#local-6989586621679121361"><span class="hs-identifier">ptcl</span></a></a><span class="hs-glyph">@</span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-var">MiniProtocolInfo</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679121362"><a href="#local-6989586621679121362"><span class="hs-identifier">miniProtocolNum</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679121363"><a href="#local-6989586621679121363"><span class="hs-identifier">miniProtocolDir</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679120953"><span class="hs-identifier hs-var">ptcls</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-identifier">mkMiniProtocolState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120943"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-100"></a><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-type">MiniProtocolInfo</span></a><span> </span><a href="#local-6989586621679120944"><span class="hs-identifier hs-type">mode</span></a><span>
</span><a name="line-101"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120943"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120944"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120943"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-102"></a><a name="mkMiniProtocolState"><a href="Network.Mux.html#mkMiniProtocolState"><span class="hs-identifier">mkMiniProtocolState</span></a></a><span> </span><a name="local-6989586621679121365"><a href="#local-6989586621679121365"><span class="hs-identifier">miniProtocolInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621679121366"><a href="#local-6989586621679121366"><span class="hs-identifier">miniProtocolIngressQueue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newTVarM"><span class="hs-identifier hs-var">newTVarM</span></a><span> </span><span class="hs-identifier hs-var">BL.empty</span><span>
</span><a name="line-104"></a><span>    </span><a name="local-6989586621679121367"><a href="#local-6989586621679121367"><span class="hs-identifier">miniProtocolStatusVar</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newTVarM"><span class="hs-identifier hs-var">newTVarM</span></a><span> </span><a href="Network.Mux.Types.html#StatusIdle"><span class="hs-identifier hs-var">StatusIdle</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-106"></a><span>       </span><a href="#local-6989586621679121365"><span class="hs-identifier hs-var">miniProtocolInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-107"></a><span>       </span><a href="#local-6989586621679121366"><span class="hs-identifier hs-var">miniProtocolIngressQueue</span></a><span class="hs-special">,</span><span>
</span><a name="line-108"></a><span>       </span><a href="#local-6989586621679121367"><span class="hs-identifier hs-var">miniProtocolStatusVar</span></a><span>
</span><a name="line-109"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">-- | Shut down the mux. This will cause 'runMux' to return. It does not</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- wait for any protocol threads to finish, so you should do that first if</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- necessary.</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-identifier">stopMux</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120941"><span class="hs-identifier hs-type">m</span></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-type">Mux</span></a><span> </span><a href="#local-6989586621679120942"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120941"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120941"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><a name="stopMux"><a href="Network.Mux.html#stopMux"><span class="hs-identifier">stopMux</span></a></a><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-var">Mux</span></a><span class="hs-special">{</span><a name="local-6989586621679121368"><a href="#local-6989586621679121368"><span class="hs-identifier">muxControlCmdQueue</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-117"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTQueue"><span class="hs-identifier hs-var">writeTQueue</span></a><span> </span><a href="#local-6989586621679121368"><span class="hs-identifier hs-var">muxControlCmdQueue</span></a><span> </span><a href="Network.Mux.html#CmdShutdown"><span class="hs-identifier hs-var">CmdShutdown</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- | runMux starts a mux bearer for the specified protocols corresponding to</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- one of the provided Versions.</span><span>
</span><a name="line-122"></a><span class="hs-comment">--</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- __Isometric flow control: analysis of head-of-line blocking of the ingress side of the multiplexer__</span><span>
</span><a name="line-124"></a><span class="hs-comment">--</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- For each mini-protocol (enumeratated by @ptcl@), mux will create two</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- channels. One for initiator and one for the responder.  Each channel will use</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- a single 'Wanton'.  When it is filled, it is put in a common queue</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- 'tsrQueue'.  This means that the queue is bound by @2 * |ptcl|@.  Every side</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- of a mini-protocol is served by a single 'Wanton': when an applicaiton sends</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- data, the channel will try to put it into the 'Wanton' (which might block).</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- 'Wanton's are taken from the 'tsrQueue' queue by one of mux threads.  This</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- elimnates head of line blocking: each mini-protocol thread can block on</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- puting more bytes into its 'Wanton', but it cannot block the other</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- mini-protocols or the thread that is reading the 'tsrQueue' queue.  This is</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- ensured since the 'muxChannel' will put only a non-empty 'Wanton' to the</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- 'tsrQueue' queue, and on such wantons the queue is never blocked.  This means</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- that  the only way the queue can block is when its empty, which means that</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- none of the mini-protocols wanted to send.  The egress part will read</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- a 'Wanton', take a fixed amount of bytes encode them in as an 'MuxSDU'; if</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- there are leftovers it will put them back in the 'Wanton' and place it at the</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- end of the queue (reading and writting to it will happen in a single STM</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- transaction which assures that the order of requests from a mini-protocol is</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- preserved.</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- Properties:</span><span>
</span><a name="line-146"></a><span class="hs-comment">--</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- * at any given time the 'tsrQueue' contains at most one</span><span>
</span><a name="line-148"></a><span class="hs-comment">--   'TranslocationServiceRequest' from a given mini-protocol of the given</span><span>
</span><a name="line-149"></a><span class="hs-comment">--   'MiniProtocolDir', thus the queue contains at most @2 * |ptcl|@</span><span>
</span><a name="line-150"></a><span class="hs-comment">--   translocation requests.</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- * at any given time each @TranslocationServiceRequest@ contains a non-empty</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- 'Wanton'</span><span>
</span><a name="line-153"></a><span class="hs-comment">--</span><span>
</span><a name="line-154"></a><span class="hs-identifier">runMux</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679120939"><a href="#local-6989586621679120939"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679120940"><a href="#local-6989586621679120940"><span class="hs-identifier">mode</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-155"></a><span>          </span><span class="hs-special">(</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-156"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadCatch"><span class="hs-identifier hs-type">MonadCatch</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-157"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadFork.html#MonadFork"><span class="hs-identifier hs-type">MonadFork</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-158"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadThrow"><span class="hs-identifier hs-type">MonadThrow</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#MonadTime"><span class="hs-identifier hs-type">MonadTime</span></a><span>  </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-160"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-161"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadMask"><span class="hs-identifier hs-type">MonadMask</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-162"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.Trace.html#MuxTrace"><span class="hs-identifier hs-type">MuxTrace</span></a><span>
</span><a name="line-164"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-type">Mux</span></a><span> </span><a href="#local-6989586621679120940"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-165"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#MuxBearer"><span class="hs-identifier hs-type">MuxBearer</span></a><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-166"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120939"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><a name="runMux"><a href="Network.Mux.html#runMux"><span class="hs-identifier">runMux</span></a></a><span> </span><a name="local-6989586621679121369"><a href="#local-6989586621679121369"><span class="hs-identifier">tracer</span></a></a><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-var">Mux</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679121370"><a href="#local-6989586621679121370"><span class="hs-identifier">muxMiniProtocols</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679121371"><a href="#local-6989586621679121371"><span class="hs-identifier">muxControlCmdQueue</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679121372"><a href="#local-6989586621679121372"><span class="hs-identifier">muxStatus</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621679121373"><a href="#local-6989586621679121373"><span class="hs-identifier">bearer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-168"></a><span>    </span><a name="local-6989586621679121377"><a href="#local-6989586621679121377"><span class="hs-identifier">egressQueue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#newTBQueue"><span class="hs-identifier hs-var">newTBQueue</span></a><span> </span><span class="hs-number">100</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span>    </span><a href="Control.Concurrent.JobPool.html#withJobPool"><span class="hs-identifier hs-var">JobPool.withJobPool</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679121378"><a href="#local-6989586621679121378"><span class="hs-identifier">jobpool</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-171"></a><span>      </span><a href="Control.Concurrent.JobPool.html#forkJob"><span class="hs-identifier hs-var">JobPool.forkJob</span></a><span> </span><a href="#local-6989586621679121378"><span class="hs-identifier hs-var">jobpool</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679121374"><span class="hs-identifier hs-var">muxerJob</span></a><span> </span><a href="#local-6989586621679121377"><span class="hs-identifier hs-var">egressQueue</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>      </span><a href="Control.Concurrent.JobPool.html#forkJob"><span class="hs-identifier hs-var">JobPool.forkJob</span></a><span> </span><a href="#local-6989586621679121378"><span class="hs-identifier hs-var">jobpool</span></a><span> </span><a href="#local-6989586621679121375"><span class="hs-identifier hs-var">demuxerJob</span></a><span>
</span><a name="line-173"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121369"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceState"><span class="hs-identifier hs-var">MuxTraceState</span></a><span> </span><a href="Network.Mux.Trace.html#Mature"><span class="hs-identifier hs-var">Mature</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>      </span><span class="hs-comment">-- Wait for someone to shut us down by calling muxStop or an error.</span><span>
</span><a name="line-176"></a><span>      </span><span class="hs-comment">-- Outstaning jobs are shut down Upon completion of withJobPool.</span><span>
</span><a name="line-177"></a><span>      </span><a href="Network.Mux.html#monitor"><span class="hs-identifier hs-var">monitor</span></a><span> </span><a href="#local-6989586621679121369"><span class="hs-identifier hs-var">tracer</span></a><span> </span><a href="#local-6989586621679121378"><span class="hs-identifier hs-var">jobpool</span></a><span> </span><a href="#local-6989586621679121377"><span class="hs-identifier hs-var">egressQueue</span></a><span> </span><a href="#local-6989586621679121371"><span class="hs-identifier hs-var">muxControlCmdQueue</span></a><span> </span><a href="#local-6989586621679121372"><span class="hs-identifier hs-var">muxStatus</span></a><span>
</span><a name="line-178"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-179"></a><span>    </span><a name="local-6989586621679121374"><a href="#local-6989586621679121374"><span class="hs-identifier">muxerJob</span></a></a><span> </span><a name="local-6989586621679121376"><a href="#local-6989586621679121376"><span class="hs-identifier">egressQueue</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-180"></a><span>      </span><a href="Control.Concurrent.JobPool.html#Job"><span class="hs-identifier hs-var">JobPool.Job</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Egress.html#muxer"><span class="hs-identifier hs-var">muxer</span></a><span> </span><a href="#local-6989586621679121376"><span class="hs-identifier hs-var">egressQueue</span></a><span> </span><a href="#local-6989586621679121373"><span class="hs-identifier hs-var">bearer</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>                  </span><a href="Network.Mux.html#MuxerException"><span class="hs-identifier hs-var">MuxerException</span></a><span> </span><span class="hs-string">&quot;muxer&quot;</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>    </span><a name="local-6989586621679121375"><a href="#local-6989586621679121375"><span class="hs-identifier">demuxerJob</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-184"></a><span>      </span><a href="Control.Concurrent.JobPool.html#Job"><span class="hs-identifier hs-var">JobPool.Job</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Ingress.html#demuxer"><span class="hs-identifier hs-var">demuxer</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621679121370"><span class="hs-identifier hs-var">muxMiniProtocols</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679121373"><span class="hs-identifier hs-var">bearer</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>                  </span><a href="Network.Mux.html#DemuxerException"><span class="hs-identifier hs-var">DemuxerException</span></a><span> </span><span class="hs-string">&quot;demuxer&quot;</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-identifier">miniProtocolJob</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679120937"><a href="#local-6989586621679120937"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679120938"><a href="#local-6989586621679120938"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-189"></a><span>     </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.Trace.html#MuxTrace"><span class="hs-identifier hs-type">MuxTrace</span></a><span>
</span><a name="line-191"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Egress.html#EgressQueue"><span class="hs-identifier hs-type">EgressQueue</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-192"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120937"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-193"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-type">MiniProtocolAction</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-194"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Control.Concurrent.JobPool.html#Job"><span class="hs-identifier hs-type">JobPool.Job</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.html#MuxJobResult"><span class="hs-identifier hs-type">MuxJobResult</span></a><span>
</span><a name="line-195"></a><a name="miniProtocolJob"><a href="Network.Mux.html#miniProtocolJob"><span class="hs-identifier">miniProtocolJob</span></a></a><span> </span><a name="local-6989586621679121379"><a href="#local-6989586621679121379"><span class="hs-identifier">tracer</span></a></a><span> </span><a name="local-6989586621679121380"><a href="#local-6989586621679121380"><span class="hs-identifier">egressQueue</span></a></a><span>
</span><a name="line-196"></a><span>                </span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-197"></a><span>                  </span><span class="hs-identifier">miniProtocolInfo</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-198"></a><span>                    </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-var">MiniProtocolInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-199"></a><span>                      </span><a name="local-6989586621679121381"><a href="#local-6989586621679121381"><span class="hs-identifier">miniProtocolNum</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-200"></a><span>                      </span><a name="local-6989586621679121382"><a href="#local-6989586621679121382"><span class="hs-identifier">miniProtocolDir</span></a></a><span>
</span><a name="line-201"></a><span>                    </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-202"></a><span>                  </span><a name="local-6989586621679121383"><a href="#local-6989586621679121383"><span class="hs-identifier">miniProtocolIngressQueue</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-203"></a><span>                  </span><a name="local-6989586621679121384"><a href="#local-6989586621679121384"><span class="hs-identifier">miniProtocolStatusVar</span></a></a><span>
</span><a name="line-204"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-205"></a><span>                </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-var">MiniProtocolAction</span></a><span> </span><a name="local-6989586621679121385"><a href="#local-6989586621679121385"><span class="hs-identifier">protocolAction</span></a></a><span> </span><a name="local-6989586621679121386"><a href="#local-6989586621679121386"><span class="hs-identifier">completionVar</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-206"></a><span>    </span><a href="Control.Concurrent.JobPool.html#Job"><span class="hs-identifier hs-var">JobPool.Job</span></a><span> </span><a href="#local-6989586621679121387"><span class="hs-identifier hs-var">jobAction</span></a><span>
</span><a name="line-207"></a><span>                </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolException"><span class="hs-identifier hs-var">MiniProtocolException</span></a><span> </span><a href="#local-6989586621679121381"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span> </span><a href="#local-6989586621679121388"><span class="hs-identifier hs-var">miniProtocolDirEnum</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679121381"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679121388"><span class="hs-identifier hs-var">miniProtocolDirEnum</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621679121387"><a href="#local-6989586621679121387"><span class="hs-identifier">jobAction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>      </span><a name="local-6989586621679121390"><a href="#local-6989586621679121390"><span class="hs-identifier">w</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newTVarM"><span class="hs-identifier hs-var">newTVarM</span></a><span> </span><span class="hs-identifier hs-var">BL.empty</span><span>
</span><a name="line-212"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679121391"><a href="#local-6989586621679121391"><span class="hs-identifier">chan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.html#muxChannel"><span class="hs-identifier hs-var">muxChannel</span></a><span> </span><a href="#local-6989586621679121379"><span class="hs-identifier hs-var">tracer</span></a><span> </span><a href="#local-6989586621679121380"><span class="hs-identifier hs-var">egressQueue</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Egress.html#Wanton"><span class="hs-identifier hs-var">Wanton</span></a><span> </span><a href="#local-6989586621679121390"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>                           </span><a href="#local-6989586621679121381"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span> </span><a href="#local-6989586621679121388"><span class="hs-identifier hs-var">miniProtocolDirEnum</span></a><span>
</span><a name="line-214"></a><span>                           </span><a href="#local-6989586621679121383"><span class="hs-identifier hs-var">miniProtocolIngressQueue</span></a><span>
</span><a name="line-215"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679121392"><a href="#local-6989586621679121392"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679121393"><a href="#local-6989586621679121393"><span class="hs-identifier">remainder</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679121385"><span class="hs-identifier hs-var">protocolAction</span></a><span> </span><a href="#local-6989586621679121391"><span class="hs-identifier hs-var">chan</span></a><span>
</span><a name="line-216"></a><span>      </span><a href="#local-6989586621679121389"><span class="hs-identifier hs-var">mpsJobExit</span></a><span> </span><a href="#local-6989586621679121390"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-217"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-218"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121384"><span class="hs-identifier hs-var">miniProtocolStatusVar</span></a><span> </span><a href="Network.Mux.Types.html#StatusIdle"><span class="hs-identifier hs-var">StatusIdle</span></a><span>
</span><a name="line-219"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#putTMVar"><span class="hs-identifier hs-var">putTMVar</span></a><span> </span><a href="#local-6989586621679121386"><span class="hs-identifier hs-var">completionVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679121392"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-220"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679121393"><span class="hs-identifier hs-var">remainder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-221"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679121394"><a href="#local-6989586621679121394"><span class="hs-identifier">trailing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-222"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a><span> </span><a href="#local-6989586621679121383"><span class="hs-identifier hs-var">miniProtocolIngressQueue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.append</span><span> </span><a href="#local-6989586621679121394"><span class="hs-identifier hs-var">trailing</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-224"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolShutdown"><span class="hs-identifier hs-var">MiniProtocolShutdown</span></a><span> </span><a href="#local-6989586621679121381"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span> </span><a href="#local-6989586621679121388"><span class="hs-identifier hs-var">miniProtocolDirEnum</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621679121388"><a href="#local-6989586621679121388"><span class="hs-identifier">miniProtocolDirEnum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121382"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-comment">-- The Wanton w is the SDUs that are queued but not yet sent for this job.</span><span>
</span><a name="line-231"></a><span>    </span><span class="hs-comment">-- Job threads will be prevented from exiting until all their SDUs have been</span><span>
</span><a name="line-232"></a><span>    </span><span class="hs-comment">-- transmitted unless an exception/error is encounter. In that case all</span><span>
</span><a name="line-233"></a><span>    </span><span class="hs-comment">-- jobs will be cancelled directly.</span><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier">mpsJobExit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Mux.Types.html#IngressQueue"><span class="hs-identifier hs-type">IngressQueue</span></a><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120938"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>    </span><a name="local-6989586621679121389"><a href="#local-6989586621679121389"><span class="hs-identifier">mpsJobExit</span></a></a><span> </span><a name="local-6989586621679121395"><a href="#local-6989586621679121395"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-236"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121379"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceState"><span class="hs-identifier hs-var">MuxTraceState</span></a><span> </span><a href="Network.Mux.Trace.html#Dying"><span class="hs-identifier hs-var">Dying</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-238"></a><span>            </span><a name="local-6989586621679121396"><a href="#local-6989586621679121396"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679121395"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-239"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.null</span><span> </span><a href="#local-6989586621679121396"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-keyword">data</span><span> </span><a name="ControlCmd"><a href="Network.Mux.html#ControlCmd"><span class="hs-identifier">ControlCmd</span></a></a><span> </span><a name="local-6989586621679120926"><a href="#local-6989586621679120926"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679120927"><a href="#local-6989586621679120927"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-242"></a><span>     </span><a name="CmdStartProtocolThread"><a href="Network.Mux.html#CmdStartProtocolThread"><span class="hs-identifier">CmdStartProtocolThread</span></a></a><span>
</span><a name="line-243"></a><span>       </span><span class="hs-glyph">!</span><a href="Network.Mux.html#StartOnDemandOrEagerly"><span class="hs-identifier hs-type">StartOnDemandOrEagerly</span></a><span>
</span><a name="line-244"></a><span>       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120926"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120927"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-type">MiniProtocolAction</span></a><span> </span><a href="#local-6989586621679120927"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="CmdShutdown"><a href="Network.Mux.html#CmdShutdown"><span class="hs-identifier">CmdShutdown</span></a></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-keyword">data</span><span> </span><a name="StartOnDemandOrEagerly"><a href="Network.Mux.html#StartOnDemandOrEagerly"><span class="hs-identifier">StartOnDemandOrEagerly</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="StartOnDemand"><a href="Network.Mux.html#StartOnDemand"><span class="hs-identifier">StartOnDemand</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="StartEagerly"><a href="Network.Mux.html#StartEagerly"><span class="hs-identifier">StartEagerly</span></a></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-keyword">data</span><span> </span><a name="MiniProtocolAction"><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier">MiniProtocolAction</span></a></a><span> </span><a name="local-6989586621679120923"><a href="#local-6989586621679120923"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-252"></a><span>     </span><a name="MiniProtocolAction"><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier">MiniProtocolAction</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Channel.html#Channel"><span class="hs-identifier hs-type">Channel</span></a><span> </span><a href="#local-6989586621679120924"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120924"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679120925"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">BL.ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Action</span><span>
</span><a name="line-253"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTMVar"><span class="hs-identifier hs-type">StrictTMVar</span></a><span> </span><a href="#local-6989586621679120924"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679120925"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ Completion var</span><span>
</span><a name="line-254"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-type">MiniProtocolAction</span></a><span> </span><a href="#local-6989586621679120924"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-comment">-- | The monitoring loop does two jobs:</span><span>
</span><a name="line-257"></a><span class="hs-comment">--</span><span>
</span><a name="line-258"></a><span class="hs-comment">--  1. it waits for mini-protocol threads to terminate</span><span>
</span><a name="line-259"></a><span class="hs-comment">--  2. it starts responder protocol threads on demand when the first</span><span>
</span><a name="line-260"></a><span class="hs-comment">--     incoming message arrives.</span><span>
</span><a name="line-261"></a><span class="hs-comment">--</span><span>
</span><a name="line-262"></a><span class="hs-identifier">monitor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679120935"><a href="#local-6989586621679120935"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679120936"><a href="#local-6989586621679120936"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadMask"><span class="hs-identifier hs-type">MonadMask</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.Trace.html#MuxTrace"><span class="hs-identifier hs-type">MuxTrace</span></a><span>
</span><a name="line-264"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Control.Concurrent.JobPool.html#JobPool"><span class="hs-identifier hs-type">JobPool.JobPool</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.html#MuxJobResult"><span class="hs-identifier hs-type">MuxJobResult</span></a><span>
</span><a name="line-265"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Egress.html#EgressQueue"><span class="hs-identifier hs-type">EgressQueue</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-266"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#ControlCmd"><span class="hs-identifier hs-type">ControlCmd</span></a><span> </span><a href="#local-6989586621679120935"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.html#MuxStatus"><span class="hs-identifier hs-type">MuxStatus</span></a><span>
</span><a name="line-268"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><a name="monitor"><a href="Network.Mux.html#monitor"><span class="hs-identifier">monitor</span></a></a><span> </span><a name="local-6989586621679121397"><a href="#local-6989586621679121397"><span class="hs-identifier">tracer</span></a></a><span> </span><a name="local-6989586621679121398"><a href="#local-6989586621679121398"><span class="hs-identifier">jobpool</span></a></a><span> </span><a name="local-6989586621679121399"><a href="#local-6989586621679121399"><span class="hs-identifier">egressQueue</span></a></a><span> </span><a name="local-6989586621679121400"><a href="#local-6989586621679121400"><span class="hs-identifier">cmdQueue</span></a></a><span> </span><a name="local-6989586621679121401"><a href="#local-6989586621679121401"><span class="hs-identifier">muxStatus</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-270"></a><span>    </span><a href="#local-6989586621679121402"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolDir"><span class="hs-identifier hs-type">MiniProtocolDir</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>              </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120935"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-type">MiniProtocolAction</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>    </span><a name="local-6989586621679121402"><a href="#local-6989586621679121402"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679121405"><a href="#local-6989586621679121405"><span class="hs-identifier">ptclsStartOnDemand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-276"></a><span>      </span><a name="local-6989586621679121408"><a href="#local-6989586621679121408"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-277"></a><span>            </span><span class="hs-comment">-- wait for a mini-protocol thread to terminate</span><span>
</span><a name="line-278"></a><span>            </span><span class="hs-special">(</span><a href="Network.Mux.html#EventJobResult"><span class="hs-identifier hs-var">EventJobResult</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Control.Concurrent.JobPool.html#collect"><span class="hs-identifier hs-var">JobPool.collect</span></a><span> </span><a href="#local-6989586621679121398"><span class="hs-identifier hs-var">jobpool</span></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span>            </span><span class="hs-comment">-- wait for a new control command</span><span>
</span><a name="line-281"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#EventControlCmd"><span class="hs-identifier hs-var">EventControlCmd</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#readTQueue"><span class="hs-identifier hs-var">readTQueue</span></a><span> </span><a href="#local-6989586621679121400"><span class="hs-identifier hs-var">cmdQueue</span></a><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span>            </span><span class="hs-comment">-- or wait for data to arrive on the channels that do not yet have</span><span>
</span><a name="line-284"></a><span>            </span><span class="hs-comment">-- responder threads running</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|&gt;</span><span class="hs-special">)</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#retry"><span class="hs-identifier hs-var">retry</span></a><span>
</span><a name="line-286"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679121403"><span class="hs-identifier hs-var">checkNonEmptyQueue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">miniProtocolIngressQueue</span><span> </span><a href="#local-6989586621679121406"><span class="hs-identifier hs-var">ptclState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-287"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#EventStartOnDemand"><span class="hs-identifier hs-var">EventStartOnDemand</span></a><span> </span><a href="#local-6989586621679121406"><span class="hs-identifier hs-var">ptclState</span></a><span> </span><a href="#local-6989586621679121407"><span class="hs-identifier hs-var">ptclAction</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679121406"><a href="#local-6989586621679121406"><span class="hs-identifier">ptclState</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679121407"><a href="#local-6989586621679121407"><span class="hs-identifier">ptclAction</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621679121405"><span class="hs-identifier hs-var">ptclsStartOnDemand</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679121408"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-291"></a><span>        </span><span class="hs-comment">-- Protocols that runs to completion are not automatically restarted.</span><span>
</span><a name="line-292"></a><span>        </span><a href="Network.Mux.html#EventJobResult"><span class="hs-identifier hs-var">EventJobResult</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolShutdown"><span class="hs-identifier hs-var">MiniProtocolShutdown</span></a><span> </span><a name="local-6989586621679121409"><a href="#local-6989586621679121409"><span class="hs-identifier">pnum</span></a></a><span> </span><a name="local-6989586621679121410"><a href="#local-6989586621679121410"><span class="hs-identifier">pmode</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-293"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceCleanExit"><span class="hs-identifier hs-var">MuxTraceCleanExit</span></a><span> </span><a href="#local-6989586621679121409"><span class="hs-identifier hs-var">pnum</span></a><span> </span><a href="#local-6989586621679121410"><span class="hs-identifier hs-var">pmode</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>          </span><a href="#local-6989586621679121402"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679121405"><span class="hs-identifier hs-var">ptclsStartOnDemand</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>        </span><a href="Network.Mux.html#EventJobResult"><span class="hs-identifier hs-var">EventJobResult</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolException"><span class="hs-identifier hs-var">MiniProtocolException</span></a><span> </span><a name="local-6989586621679121411"><a href="#local-6989586621679121411"><span class="hs-identifier">pnum</span></a></a><span> </span><a name="local-6989586621679121412"><a href="#local-6989586621679121412"><span class="hs-identifier">pmode</span></a></a><span> </span><a name="local-6989586621679121413"><a href="#local-6989586621679121413"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-297"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceState"><span class="hs-identifier hs-var">MuxTraceState</span></a><span> </span><a href="Network.Mux.Trace.html#Dead"><span class="hs-identifier hs-var">Dead</span></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceExceptionExit"><span class="hs-identifier hs-var">MuxTraceExceptionExit</span></a><span> </span><a href="#local-6989586621679121411"><span class="hs-identifier hs-var">pnum</span></a><span> </span><a href="#local-6989586621679121412"><span class="hs-identifier hs-var">pmode</span></a><span> </span><a href="#local-6989586621679121413"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121401"><span class="hs-identifier hs-var">muxStatus</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.html#MuxFailed"><span class="hs-identifier hs-var">MuxFailed</span></a><span> </span><a href="#local-6989586621679121413"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-300"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><a href="#local-6989586621679121413"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>        </span><span class="hs-comment">-- These two cover internal and protocol errors, but always fatal, so propagate.</span><span>
</span><a name="line-303"></a><span>        </span><span class="hs-comment">--TODO: decide if we should have exception wrappers here to identify</span><span>
</span><a name="line-304"></a><span>        </span><span class="hs-comment">-- the source of the failure, e.g. specific mini-protocol. If we're</span><span>
</span><a name="line-305"></a><span>        </span><span class="hs-comment">-- propagating exceptions, we don't need to log them.</span><span>
</span><a name="line-306"></a><span>        </span><a href="Network.Mux.html#EventJobResult"><span class="hs-identifier hs-var">EventJobResult</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#MuxerException"><span class="hs-identifier hs-var">MuxerException</span></a><span> </span><a name="local-6989586621679121414"><a href="#local-6989586621679121414"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-307"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceState"><span class="hs-identifier hs-var">MuxTraceState</span></a><span> </span><a href="Network.Mux.Trace.html#Dead"><span class="hs-identifier hs-var">Dead</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121401"><span class="hs-identifier hs-var">muxStatus</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.html#MuxFailed"><span class="hs-identifier hs-var">MuxFailed</span></a><span> </span><a href="#local-6989586621679121414"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-309"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><a href="#local-6989586621679121414"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-310"></a><span>        </span><a href="Network.Mux.html#EventJobResult"><span class="hs-identifier hs-var">EventJobResult</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#DemuxerException"><span class="hs-identifier hs-var">DemuxerException</span></a><span> </span><a name="local-6989586621679121415"><a href="#local-6989586621679121415"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-311"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceState"><span class="hs-identifier hs-var">MuxTraceState</span></a><span> </span><a href="Network.Mux.Trace.html#Dead"><span class="hs-identifier hs-var">Dead</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121401"><span class="hs-identifier hs-var">muxStatus</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.html#MuxFailed"><span class="hs-identifier hs-var">MuxFailed</span></a><span> </span><a href="#local-6989586621679121415"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-313"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><a href="#local-6989586621679121415"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span>        </span><a href="Network.Mux.html#EventControlCmd"><span class="hs-identifier hs-var">EventControlCmd</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#CmdStartProtocolThread"><span class="hs-identifier hs-var">CmdStartProtocolThread</span></a><span>
</span><a name="line-316"></a><span>                           </span><a href="Network.Mux.html#StartEagerly"><span class="hs-identifier hs-var">StartEagerly</span></a><span>
</span><a name="line-317"></a><span>                           </span><a name="local-6989586621679121416"><a href="#local-6989586621679121416"><span class="hs-identifier">ptclState</span></a></a><span class="hs-glyph">@</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-318"></a><span>                             </span><span class="hs-identifier">miniProtocolInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-var">MiniProtocolInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-319"></a><span>                               </span><a name="local-6989586621679121417"><a href="#local-6989586621679121417"><span class="hs-identifier">miniProtocolNum</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-320"></a><span>                               </span><a name="local-6989586621679121418"><a href="#local-6989586621679121418"><span class="hs-identifier">miniProtocolDir</span></a></a><span>
</span><a name="line-321"></a><span>                             </span><span class="hs-special">}</span><span>
</span><a name="line-322"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-323"></a><span>                           </span><a name="local-6989586621679121419"><a href="#local-6989586621679121419"><span class="hs-identifier">ptclAction</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-324"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceStartEagerly"><span class="hs-identifier hs-var">MuxTraceStartEagerly</span></a><span> </span><a href="#local-6989586621679121417"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span>
</span><a name="line-325"></a><span>                             </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121418"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>          </span><a href="Control.Concurrent.JobPool.html#forkJob"><span class="hs-identifier hs-var">JobPool.forkJob</span></a><span> </span><a href="#local-6989586621679121398"><span class="hs-identifier hs-var">jobpool</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-327"></a><span>            </span><a href="Network.Mux.html#miniProtocolJob"><span class="hs-identifier hs-var">miniProtocolJob</span></a><span>
</span><a name="line-328"></a><span>              </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span>
</span><a name="line-329"></a><span>              </span><a href="#local-6989586621679121399"><span class="hs-identifier hs-var">egressQueue</span></a><span>
</span><a name="line-330"></a><span>              </span><a href="#local-6989586621679121416"><span class="hs-identifier hs-var">ptclState</span></a><span>
</span><a name="line-331"></a><span>              </span><a href="#local-6989586621679121419"><span class="hs-identifier hs-var">ptclAction</span></a><span>
</span><a name="line-332"></a><span>          </span><a href="#local-6989586621679121402"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679121405"><span class="hs-identifier hs-var">ptclsStartOnDemand</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>        </span><a href="Network.Mux.html#EventControlCmd"><span class="hs-identifier hs-var">EventControlCmd</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#CmdStartProtocolThread"><span class="hs-identifier hs-var">CmdStartProtocolThread</span></a><span>
</span><a name="line-335"></a><span>                           </span><a href="Network.Mux.html#StartOnDemand"><span class="hs-identifier hs-var">StartOnDemand</span></a><span>
</span><a name="line-336"></a><span>                           </span><a name="local-6989586621679121420"><a href="#local-6989586621679121420"><span class="hs-identifier">ptclState</span></a></a><span class="hs-glyph">@</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-337"></a><span>                             </span><span class="hs-identifier">miniProtocolInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-var">MiniProtocolInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-338"></a><span>                               </span><a name="local-6989586621679121421"><a href="#local-6989586621679121421"><span class="hs-identifier">miniProtocolNum</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-339"></a><span>                               </span><a name="local-6989586621679121422"><a href="#local-6989586621679121422"><span class="hs-identifier">miniProtocolDir</span></a></a><span>
</span><a name="line-340"></a><span>                             </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-342"></a><span>                           </span><a name="local-6989586621679121423"><a href="#local-6989586621679121423"><span class="hs-identifier">ptclAction</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-343"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679121424"><a href="#local-6989586621679121424"><span class="hs-identifier">ptclsStartOnDemand'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679121404"><span class="hs-identifier hs-var">protocolKey</span></a><span> </span><a href="#local-6989586621679121420"><span class="hs-identifier hs-var">ptclState</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>                                               </span><span class="hs-special">(</span><a href="#local-6989586621679121420"><span class="hs-identifier hs-var">ptclState</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679121423"><span class="hs-identifier hs-var">ptclAction</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>                                               </span><a href="#local-6989586621679121405"><span class="hs-identifier hs-var">ptclsStartOnDemand</span></a><span>
</span><a name="line-346"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceStartedOnDemand"><span class="hs-identifier hs-var">MuxTraceStartedOnDemand</span></a><span> </span><a href="#local-6989586621679121421"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span>
</span><a name="line-347"></a><span>                             </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121422"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>          </span><a href="#local-6989586621679121402"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679121424"><span class="hs-identifier hs-var">ptclsStartOnDemand'</span></a><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span>        </span><a href="Network.Mux.html#EventControlCmd"><span class="hs-identifier hs-var">EventControlCmd</span></a><span> </span><a href="Network.Mux.html#CmdShutdown"><span class="hs-identifier hs-var">CmdShutdown</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-351"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><a href="Network.Mux.Trace.html#MuxTraceShutdown"><span class="hs-identifier hs-var">MuxTraceShutdown</span></a><span>
</span><a name="line-352"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121401"><span class="hs-identifier hs-var">muxStatus</span></a><span> </span><a href="Network.Mux.html#MuxStopped"><span class="hs-identifier hs-var">MuxStopped</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>        </span><span class="hs-comment">-- Data has arrived on a channel for a mini-protocol for which we have</span><span>
</span><a name="line-355"></a><span>        </span><span class="hs-comment">-- an on-demand-start protocol thread. So we start it now.</span><span>
</span><a name="line-356"></a><span>        </span><a href="Network.Mux.html#EventStartOnDemand"><span class="hs-identifier hs-var">EventStartOnDemand</span></a><span> </span><a name="local-6989586621679121425"><a href="#local-6989586621679121425"><span class="hs-identifier">ptclState</span></a></a><span class="hs-glyph">@</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-357"></a><span>                             </span><span class="hs-identifier">miniProtocolInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-var">MiniProtocolInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-358"></a><span>                               </span><a name="local-6989586621679121426"><a href="#local-6989586621679121426"><span class="hs-identifier">miniProtocolNum</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-359"></a><span>                               </span><a name="local-6989586621679121427"><a href="#local-6989586621679121427"><span class="hs-identifier">miniProtocolDir</span></a></a><span>
</span><a name="line-360"></a><span>                             </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-361"></a><span>                             </span><a name="local-6989586621679121428"><a href="#local-6989586621679121428"><span class="hs-identifier">miniProtocolStatusVar</span></a></a><span>
</span><a name="line-362"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-363"></a><span>                           </span><a name="local-6989586621679121429"><a href="#local-6989586621679121429"><span class="hs-identifier">ptclAction</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-364"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceStartOnDemand"><span class="hs-identifier hs-var">MuxTraceStartOnDemand</span></a><span> </span><a href="#local-6989586621679121426"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span>
</span><a name="line-365"></a><span>                             </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121427"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121428"><span class="hs-identifier hs-var">miniProtocolStatusVar</span></a><span> </span><a href="Network.Mux.Types.html#StatusRunning"><span class="hs-identifier hs-var">StatusRunning</span></a><span>
</span><a name="line-367"></a><span>          </span><a href="Control.Concurrent.JobPool.html#forkJob"><span class="hs-identifier hs-var">JobPool.forkJob</span></a><span> </span><a href="#local-6989586621679121398"><span class="hs-identifier hs-var">jobpool</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-368"></a><span>            </span><a href="Network.Mux.html#miniProtocolJob"><span class="hs-identifier hs-var">miniProtocolJob</span></a><span>
</span><a name="line-369"></a><span>              </span><a href="#local-6989586621679121397"><span class="hs-identifier hs-var">tracer</span></a><span>
</span><a name="line-370"></a><span>              </span><a href="#local-6989586621679121399"><span class="hs-identifier hs-var">egressQueue</span></a><span>
</span><a name="line-371"></a><span>              </span><a href="#local-6989586621679121425"><span class="hs-identifier hs-var">ptclState</span></a><span>
</span><a name="line-372"></a><span>              </span><a href="#local-6989586621679121429"><span class="hs-identifier hs-var">ptclAction</span></a><span>
</span><a name="line-373"></a><span>          </span><a href="#local-6989586621679121402"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.delete</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679121426"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679121430"><span class="hs-identifier hs-var">miniProtocolDirEnum</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679121405"><span class="hs-identifier hs-var">ptclsStartOnDemand</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-375"></a><span>            </span><a name="local-6989586621679121430"><a href="#local-6989586621679121430"><span class="hs-identifier">miniProtocolDirEnum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121427"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-identifier">checkNonEmptyQueue</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Mux.Types.html#IngressQueue"><span class="hs-identifier hs-type">IngressQueue</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679120936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621679121403"><a href="#local-6989586621679121403"><span class="hs-identifier">checkNonEmptyQueue</span></a></a><span> </span><a name="local-6989586621679121431"><a href="#local-6989586621679121431"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-379"></a><span>      </span><a name="local-6989586621679121432"><a href="#local-6989586621679121432"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679121431"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-380"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.null</span><span> </span><a href="#local-6989586621679121432"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>    </span><a name="local-6989586621679121404"><a href="#local-6989586621679121404"><span class="hs-identifier">protocolKey</span></a></a><span> </span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-383"></a><span>                  </span><span class="hs-identifier">miniProtocolInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolInfo"><span class="hs-identifier hs-var">MiniProtocolInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-384"></a><span>                    </span><a name="local-6989586621679121433"><a href="#local-6989586621679121433"><span class="hs-identifier">miniProtocolNum</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-385"></a><span>                    </span><a name="local-6989586621679121434"><a href="#local-6989586621679121434"><span class="hs-identifier">miniProtocolDir</span></a></a><span>
</span><a name="line-386"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-387"></a><span>                </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-388"></a><span>      </span><span class="hs-special">(</span><a href="#local-6989586621679121433"><span class="hs-identifier hs-var">miniProtocolNum</span></a><span class="hs-special">,</span><span> </span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121434"><span class="hs-identifier hs-var">miniProtocolDir</span></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span class="hs-keyword">data</span><span> </span><a name="MonitorEvent"><a href="Network.Mux.html#MonitorEvent"><span class="hs-identifier">MonitorEvent</span></a></a><span> </span><a name="local-6989586621679120921"><a href="#local-6989586621679120921"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679120922"><a href="#local-6989586621679120922"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-391"></a><span>     </span><a name="EventJobResult"><a href="Network.Mux.html#EventJobResult"><span class="hs-identifier">EventJobResult</span></a></a><span>  </span><a href="Network.Mux.html#MuxJobResult"><span class="hs-identifier hs-type">MuxJobResult</span></a><span>
</span><a name="line-392"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="EventControlCmd"><a href="Network.Mux.html#EventControlCmd"><span class="hs-identifier">EventControlCmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.html#ControlCmd"><span class="hs-identifier hs-type">ControlCmd</span></a><span> </span><a href="#local-6989586621679120921"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120922"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="EventStartOnDemand"><a href="Network.Mux.html#EventStartOnDemand"><span class="hs-identifier">EventStartOnDemand</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a><span> </span><a href="#local-6989586621679120921"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120922"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>                        </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-type">MiniProtocolAction</span></a><span> </span><a href="#local-6989586621679120922"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">-- | The mux forks off a number of threads and its main thread waits and</span><span>
</span><a name="line-397"></a><span class="hs-comment">-- monitors them all. This type covers the different thread and their possible</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- termination behaviour.</span><span>
</span><a name="line-399"></a><span class="hs-comment">--</span><span>
</span><a name="line-400"></a><span class="hs-keyword">data</span><span> </span><a name="MuxJobResult"><a href="Network.Mux.html#MuxJobResult"><span class="hs-identifier">MuxJobResult</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span>       </span><span class="hs-comment">-- | A mini-protocol thread terminated with a result.</span><span>
</span><a name="line-403"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-404"></a><span>       </span><a name="MiniProtocolShutdown"><a href="Network.Mux.html#MiniProtocolShutdown"><span class="hs-identifier">MiniProtocolShutdown</span></a></a><span> </span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span> </span><a href="Network.Mux.Types.html#MiniProtocolDir"><span class="hs-identifier hs-type">MiniProtocolDir</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>       </span><span class="hs-comment">-- | A mini-protocol thread terminated with an exception. We always</span><span>
</span><a name="line-407"></a><span>       </span><span class="hs-comment">-- respond by terminating the whole mux.</span><span>
</span><a name="line-408"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="MiniProtocolException"><a href="Network.Mux.html#MiniProtocolException"><span class="hs-identifier">MiniProtocolException</span></a></a><span> </span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span> </span><a href="Network.Mux.Types.html#MiniProtocolDir"><span class="hs-identifier hs-type">MiniProtocolDir</span></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span>       </span><span class="hs-comment">-- | Exception in the 'mux' thread. Always fatal.</span><span>
</span><a name="line-411"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="MuxerException"><a href="Network.Mux.html#MuxerException"><span class="hs-identifier">MuxerException</span></a></a><span>   </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>       </span><span class="hs-comment">-- | Exception in the 'demux' thread. Always fatal.</span><span>
</span><a name="line-414"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="DemuxerException"><a href="Network.Mux.html#DemuxerException"><span class="hs-identifier">DemuxerException</span></a></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-comment">-- | muxChannel creates a duplex channel for a specific 'MiniProtocolId' and</span><span>
</span><a name="line-418"></a><span class="hs-comment">-- 'MiniProtocolDir'.</span><span>
</span><a name="line-419"></a><span class="hs-comment">--</span><span>
</span><a name="line-420"></a><span class="hs-identifier">muxChannel</span><span>
</span><a name="line-421"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679120934"><a href="#local-6989586621679120934"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-422"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-423"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.Trace.html#MuxTrace"><span class="hs-identifier hs-type">MuxTrace</span></a><span>
</span><a name="line-425"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Egress.html#EgressQueue"><span class="hs-identifier hs-type">EgressQueue</span></a><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-426"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Egress.html#Wanton"><span class="hs-identifier hs-type">Wanton</span></a><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-427"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span>
</span><a name="line-428"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolDir"><span class="hs-identifier hs-type">MiniProtocolDir</span></a><span>
</span><a name="line-429"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#IngressQueue"><span class="hs-identifier hs-type">IngressQueue</span></a><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-430"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Channel.html#Channel"><span class="hs-identifier hs-type">Channel</span></a><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-431"></a><a name="muxChannel"><a href="Network.Mux.html#muxChannel"><span class="hs-identifier">muxChannel</span></a></a><span> </span><a name="local-6989586621679121435"><a href="#local-6989586621679121435"><span class="hs-identifier">tracer</span></a></a><span> </span><a name="local-6989586621679121436"><a href="#local-6989586621679121436"><span class="hs-identifier">egressQueue</span></a></a><span> </span><a name="local-6989586621679121437"><a href="#local-6989586621679121437"><span class="hs-identifier">want</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Network.Mux.Egress.html#Wanton"><span class="hs-identifier hs-var">Wanton</span></a><span> </span><a name="local-6989586621679121438"><a href="#local-6989586621679121438"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679121439"><a href="#local-6989586621679121439"><span class="hs-identifier">mc</span></a></a><span> </span><a name="local-6989586621679121440"><a href="#local-6989586621679121440"><span class="hs-identifier">md</span></a></a><span> </span><a name="local-6989586621679121441"><a href="#local-6989586621679121441"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-432"></a><span>    </span><a href="Network.Mux.Channel.html#Channel"><span class="hs-identifier hs-var">Channel</span></a><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621679121443"><span class="hs-identifier hs-var">send</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679121444"><span class="hs-identifier hs-var">recv</span></a><span class="hs-special">}</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-434"></a><span>    </span><span class="hs-comment">-- Limit for the message buffer between send and mux thread.</span><span>
</span><a name="line-435"></a><span>    </span><span class="hs-identifier">perMiniProtocolBufferSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int64</span><span>
</span><a name="line-436"></a><span>    </span><a name="local-6989586621679121442"><a href="#local-6989586621679121442"><span class="hs-identifier">perMiniProtocolBufferSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0x3ffff</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>    </span><span class="hs-identifier">send</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BL.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>    </span><a name="local-6989586621679121443"><a href="#local-6989586621679121443"><span class="hs-identifier">send</span></a></a><span> </span><a name="local-6989586621679121445"><a href="#local-6989586621679121445"><span class="hs-identifier">encoding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-440"></a><span>        </span><span class="hs-comment">-- We send CBOR encoded messages by encoding them into by ByteString</span><span>
</span><a name="line-441"></a><span>        </span><span class="hs-comment">-- forwarding them to the 'mux' thread, see 'Desired servicing semantics'.</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121435"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.Trace.html#MuxTraceChannelSendStart"><span class="hs-identifier hs-var">MuxTraceChannelSendStart</span></a><span> </span><a href="#local-6989586621679121439"><span class="hs-identifier hs-var">mc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BL.length</span><span> </span><a href="#local-6989586621679121445"><span class="hs-identifier hs-var">encoding</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-446"></a><span>            </span><a name="local-6989586621679121446"><a href="#local-6989586621679121446"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679121438"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-447"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">BL.length</span><span> </span><a href="#local-6989586621679121446"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679121442"><span class="hs-identifier hs-var">perMiniProtocolBufferSize</span></a><span>
</span><a name="line-448"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-449"></a><span>                   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679121447"><a href="#local-6989586621679121447"><span class="hs-identifier">wasEmpty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BL.null</span><span> </span><a href="#local-6989586621679121446"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-450"></a><span>                   </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121438"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BL.append</span><span> </span><a href="#local-6989586621679121446"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621679121445"><span class="hs-identifier hs-var">encoding</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>                   </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679121447"><span class="hs-identifier hs-var">wasEmpty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-452"></a><span>                     </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTBQueue"><span class="hs-identifier hs-var">writeTBQueue</span></a><span> </span><a href="#local-6989586621679121436"><span class="hs-identifier hs-var">egressQueue</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Egress.html#TLSRDemand"><span class="hs-identifier hs-var">TLSRDemand</span></a><span> </span><a href="#local-6989586621679121439"><span class="hs-identifier hs-var">mc</span></a><span> </span><a href="#local-6989586621679121440"><span class="hs-identifier hs-var">md</span></a><span> </span><a href="#local-6989586621679121437"><span class="hs-identifier hs-var">want</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>               </span><span class="hs-keyword">else</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#retry"><span class="hs-identifier hs-var">retry</span></a><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121435"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.Trace.html#MuxTraceChannelSendEnd"><span class="hs-identifier hs-var">MuxTraceChannelSendEnd</span></a><span> </span><a href="#local-6989586621679121439"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span>    </span><span class="hs-identifier">recv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679120934"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">BL.ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>    </span><a name="local-6989586621679121444"><a href="#local-6989586621679121444"><span class="hs-identifier">recv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-459"></a><span>        </span><span class="hs-comment">-- We receive CBOR encoded messages as ByteStrings (possibly partial) from the</span><span>
</span><a name="line-460"></a><span>        </span><span class="hs-comment">-- matching ingress queueu. This is the same queue the 'demux' thread writes to.</span><span>
</span><a name="line-461"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121435"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.Trace.html#MuxTraceChannelRecvStart"><span class="hs-identifier hs-var">MuxTraceChannelRecvStart</span></a><span> </span><a href="#local-6989586621679121439"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-462"></a><span>        </span><a name="local-6989586621679121449"><a href="#local-6989586621679121449"><span class="hs-identifier">blob</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-463"></a><span>            </span><a name="local-6989586621679121448"><a href="#local-6989586621679121448"><span class="hs-identifier">blob</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679121441"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-464"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679121448"><span class="hs-identifier hs-var">blob</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">BL.empty</span><span>
</span><a name="line-465"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#retry"><span class="hs-identifier hs-var">retry</span></a><span>
</span><a name="line-466"></a><span>                </span><span class="hs-keyword">else</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121441"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-identifier hs-var">BL.empty</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679121448"><span class="hs-identifier hs-var">blob</span></a><span>
</span><a name="line-467"></a><span>        </span><span class="hs-comment">-- say $ printf &quot;recv mid %s mode %s blob len %d&quot; (show mid) (show md) (BL.length blob)</span><span>
</span><a name="line-468"></a><span>        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121435"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Mux.Trace.html#MuxTraceChannelRecvEnd"><span class="hs-identifier hs-var">MuxTraceChannelRecvEnd</span></a><span> </span><a href="#local-6989586621679121439"><span class="hs-identifier hs-var">mc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BL.length</span><span> </span><a href="#local-6989586621679121449"><span class="hs-identifier hs-var">blob</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679121449"><span class="hs-identifier hs-var">blob</span></a><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span class="hs-identifier">traceMuxBearerState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679120933"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Network.Mux.Trace.html#MuxTrace"><span class="hs-identifier hs-type">MuxTrace</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Trace.html#MuxBearerState"><span class="hs-identifier hs-type">MuxBearerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120933"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-472"></a><a name="traceMuxBearerState"><a href="Network.Mux.html#traceMuxBearerState"><span class="hs-identifier">traceMuxBearerState</span></a></a><span> </span><a name="local-6989586621679121450"><a href="#local-6989586621679121450"><span class="hs-identifier">tracer</span></a></a><span> </span><a name="local-6989586621679121451"><a href="#local-6989586621679121451"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-473"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679121450"><span class="hs-identifier hs-var">tracer</span></a><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxTraceState"><span class="hs-identifier hs-var">MuxTraceState</span></a><span> </span><a href="#local-6989586621679121451"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-comment">--</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- Starting mini-protocol threads</span><span>
</span><a name="line-477"></a><span class="hs-comment">--</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-comment">-- | Arrange to run a protocol thread (for a particular 'MiniProtocolNum' and</span><span>
</span><a name="line-480"></a><span class="hs-comment">-- 'MiniProtocolDirection') to interact on this protocol's 'Channel'.</span><span>
</span><a name="line-481"></a><span class="hs-comment">--</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- The protocol thread can either be started eagerly or on-demand:</span><span>
</span><a name="line-483"></a><span class="hs-comment">--</span><span>
</span><a name="line-484"></a><span class="hs-comment">-- * With 'StartEagerly', the thread is started promptly. This is appropriate</span><span>
</span><a name="line-485"></a><span class="hs-comment">--   for mini-protocols where the opening message may be sent by this thread.</span><span>
</span><a name="line-486"></a><span class="hs-comment">--</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- * With 'StartOnDemand', the thread is not started until the first data is</span><span>
</span><a name="line-488"></a><span class="hs-comment">--   received for this mini-protocol. This is appropriate for mini-protocols</span><span>
</span><a name="line-489"></a><span class="hs-comment">--   where the opening message is sent by the remote peer.</span><span>
</span><a name="line-490"></a><span class="hs-comment">--</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- The result is a STM action to block and wait on the protocol completion.</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- It is safe to call this completion action multiple times: it will always</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- return the same result once the protocol thread completes.</span><span>
</span><a name="line-494"></a><span class="hs-comment">-- Incase the Mux has stopped, either due to an exception or because of a call</span><span>
</span><a name="line-495"></a><span class="hs-comment">-- to muxStop a `Left MuxError` will be returned from the STM action.</span><span>
</span><a name="line-496"></a><span class="hs-comment">--</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- It is an error to start a new protocol thread while one is still running,</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- for the same 'MiniProtocolNum' and 'MiniProtocolDirection'. This can easily be</span><span>
</span><a name="line-499"></a><span class="hs-comment">-- avoided by using the STM completion action to wait for the previous one to</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- finish.</span><span>
</span><a name="line-501"></a><span class="hs-comment">--</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- It is safe to ask to start a protocol thread before 'runMux'. In this case</span><span>
</span><a name="line-503"></a><span class="hs-comment">-- the protocol thread will not actually start until 'runMux' is called,</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- irrespective of the 'StartOnDemandOrEagerly' value.</span><span>
</span><a name="line-505"></a><span class="hs-comment">--</span><span>
</span><a name="line-506"></a><span class="hs-identifier">runMiniProtocol</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679120930"><a href="#local-6989586621679120930"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679120931"><a href="#local-6989586621679120931"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679120932"><a href="#local-6989586621679120932"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-507"></a><span>                   </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679120931"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-508"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-type">Mux</span></a><span> </span><a href="#local-6989586621679120930"><span class="hs-identifier hs-type">mode</span></a><span> </span><a href="#local-6989586621679120931"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-509"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolNum"><span class="hs-identifier hs-type">MiniProtocolNum</span></a><span>
</span><a name="line-510"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#MiniProtocolDirection"><span class="hs-identifier hs-type">MiniProtocolDirection</span></a><span> </span><a href="#local-6989586621679120930"><span class="hs-identifier hs-type">mode</span></a><span>
</span><a name="line-511"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.html#StartOnDemandOrEagerly"><span class="hs-identifier hs-type">StartOnDemandOrEagerly</span></a><span>
</span><a name="line-512"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Channel.html#Channel"><span class="hs-identifier hs-type">Channel</span></a><span> </span><a href="#local-6989586621679120931"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120931"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679120932"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">BL.ByteString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679120931"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679120931"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679120932"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-514"></a><a name="runMiniProtocol"><a href="Network.Mux.html#runMiniProtocol"><span class="hs-identifier">runMiniProtocol</span></a></a><span> </span><a href="Network.Mux.html#Mux"><span class="hs-identifier hs-var">Mux</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679121452"><a href="#local-6989586621679121452"><span class="hs-identifier">muxMiniProtocols</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679121453"><a href="#local-6989586621679121453"><span class="hs-identifier">muxControlCmdQueue</span></a></a><span> </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679121454"><a href="#local-6989586621679121454"><span class="hs-identifier">muxStatus</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-515"></a><span>                </span><a name="local-6989586621679121455"><a href="#local-6989586621679121455"><span class="hs-identifier">ptclNum</span></a></a><span> </span><a name="local-6989586621679121456"><a href="#local-6989586621679121456"><span class="hs-identifier">ptclDir</span></a></a><span> </span><a name="local-6989586621679121457"><a href="#local-6989586621679121457"><span class="hs-identifier">startMode</span></a></a><span> </span><a name="local-6989586621679121458"><a href="#local-6989586621679121458"><span class="hs-identifier">protocolAction</span></a></a><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span>    </span><span class="hs-comment">-- Ensure the mini-protocol is known and get the status var</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679121463"><a href="#local-6989586621679121463"><span class="hs-identifier">ptclState</span></a></a><span class="hs-glyph">@</span><a href="Network.Mux.Types.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a><span class="hs-special">{</span><a name="local-6989586621679121464"><a href="#local-6989586621679121464"><span class="hs-identifier">miniProtocolStatusVar</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-519"></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679121455"><span class="hs-identifier hs-var">ptclNum</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679121459"><span class="hs-identifier hs-var">ptclDir'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679121452"><span class="hs-identifier hs-var">muxMiniProtocols</span></a><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>      </span><span class="hs-comment">-- Make sure no thread is currently running, and update the status to</span><span>
</span><a name="line-524"></a><span>      </span><span class="hs-comment">-- indicate a thread is running (or ready to start on demand)</span><span>
</span><a name="line-525"></a><span>      </span><a name="local-6989586621679121465"><a href="#local-6989586621679121465"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679121464"><span class="hs-identifier hs-var">miniProtocolStatusVar</span></a><span>
</span><a name="line-526"></a><span>      </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679121465"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.Mux.Types.html#StatusIdle"><span class="hs-identifier hs-var">StatusIdle</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-527"></a><span>        </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;runMiniProtocol: protocol thread already running for &quot;</span><span>
</span><a name="line-528"></a><span>             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679121455"><span class="hs-identifier hs-var">ptclNum</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679121459"><span class="hs-identifier hs-var">ptclDir'</span></a><span>
</span><a name="line-529"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679121466"><a href="#local-6989586621679121466"><span class="hs-identifier">status'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679121457"><span class="hs-identifier hs-var">startMode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-530"></a><span>                       </span><a href="Network.Mux.html#StartOnDemand"><span class="hs-identifier hs-var">StartOnDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#StatusStartOnDemand"><span class="hs-identifier hs-var">StatusStartOnDemand</span></a><span>
</span><a name="line-531"></a><span>                       </span><a href="Network.Mux.html#StartEagerly"><span class="hs-identifier hs-var">StartEagerly</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Mux.Types.html#StatusRunning"><span class="hs-identifier hs-var">StatusRunning</span></a><span>
</span><a name="line-532"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679121464"><span class="hs-identifier hs-var">miniProtocolStatusVar</span></a><span> </span><a href="#local-6989586621679121466"><span class="hs-identifier hs-var">status'</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>      </span><span class="hs-comment">-- Tell the mux control to start the thread</span><span>
</span><a name="line-535"></a><span>      </span><a name="local-6989586621679121467"><a href="#local-6989586621679121467"><span class="hs-identifier">completionVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newEmptyTMVar"><span class="hs-identifier hs-var">newEmptyTMVar</span></a><span>
</span><a name="line-536"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTQueue"><span class="hs-identifier hs-var">writeTQueue</span></a><span> </span><a href="#local-6989586621679121453"><span class="hs-identifier hs-var">muxControlCmdQueue</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-537"></a><span>        </span><a href="Network.Mux.html#CmdStartProtocolThread"><span class="hs-identifier hs-var">CmdStartProtocolThread</span></a><span>
</span><a name="line-538"></a><span>          </span><a href="#local-6989586621679121457"><span class="hs-identifier hs-var">startMode</span></a><span>
</span><a name="line-539"></a><span>          </span><a href="#local-6989586621679121463"><span class="hs-identifier hs-var">ptclState</span></a><span>
</span><a name="line-540"></a><span>          </span><span class="hs-special">(</span><a href="Network.Mux.html#MiniProtocolAction"><span class="hs-identifier hs-var">MiniProtocolAction</span></a><span> </span><a href="#local-6989586621679121458"><span class="hs-identifier hs-var">protocolAction</span></a><span> </span><a href="#local-6989586621679121467"><span class="hs-identifier hs-var">completionVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679121460"><span class="hs-identifier hs-var">completionAction</span></a><span> </span><a href="#local-6989586621679121467"><span class="hs-identifier hs-var">completionVar</span></a><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>    </span><span class="hs-comment">-- It is a programmer error to get the wrong protocol, but this is also</span><span>
</span><a name="line-545"></a><span>    </span><span class="hs-comment">-- very easy to avoid.</span><span>
</span><a name="line-546"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;runMiniProtocol: no such protocol num and mode in this mux: &quot;</span><span>
</span><a name="line-548"></a><span>         </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679121455"><span class="hs-identifier hs-var">ptclNum</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679121459"><span class="hs-identifier hs-var">ptclDir'</span></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-550"></a><span>    </span><a name="local-6989586621679121459"><a href="#local-6989586621679121459"><span class="hs-identifier">ptclDir'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Mux.Types.html#protocolDirEnum"><span class="hs-identifier hs-var">protocolDirEnum</span></a><span> </span><a href="#local-6989586621679121456"><span class="hs-identifier hs-var">ptclDir</span></a><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span>    </span><span class="hs-comment">-- Wait for the miniprotocol to complete.</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-comment">-- If the mux was stopped through a call to 'stopMux' (MuxStopped)</span><span>
</span><a name="line-554"></a><span>    </span><span class="hs-comment">-- or in case of an error (MuxFailed) we return the result of</span><span>
</span><a name="line-555"></a><span>    </span><span class="hs-comment">-- the miniprotocol, or a `MuxError` if it was still running.</span><span>
</span><a name="line-556"></a><span>    </span><a name="local-6989586621679121460"><a href="#local-6989586621679121460"><span class="hs-identifier">completionAction</span></a></a><span> </span><a name="local-6989586621679121461"><a href="#local-6989586621679121461"><span class="hs-identifier">completionVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-557"></a><span>      </span><a name="local-6989586621679121462"><a href="#local-6989586621679121462"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679121454"><span class="hs-identifier hs-var">muxStatus</span></a><span>
</span><a name="line-558"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679121462"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-559"></a><span>           </span><a href="Network.Mux.html#MuxReady"><span class="hs-identifier hs-var">MuxReady</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTMVar"><span class="hs-identifier hs-var">readTMVar</span></a><span> </span><a href="#local-6989586621679121461"><span class="hs-identifier hs-var">completionVar</span></a><span>
</span><a name="line-560"></a><span>           </span><a href="Network.Mux.html#MuxStopped"><span class="hs-identifier hs-var">MuxStopped</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTMVar"><span class="hs-identifier hs-var">readTMVar</span></a><span> </span><a href="#local-6989586621679121461"><span class="hs-identifier hs-var">completionVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>             </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toException</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxError"><span class="hs-identifier hs-var">MuxError</span></a><span> </span><a href="Network.Mux.Trace.html#MuxShutdown"><span class="hs-identifier hs-var">MuxShutdown</span></a><span> </span><span class="hs-string">&quot;Mux stopped&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>           </span><a href="Network.Mux.html#MuxFailed"><span class="hs-identifier hs-var">MuxFailed</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTMVar"><span class="hs-identifier hs-var">readTMVar</span></a><span> </span><a href="#local-6989586621679121461"><span class="hs-identifier hs-var">completionVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>             </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toException</span><span> </span><span class="hs-special">(</span><a href="Network.Mux.Trace.html#MuxError"><span class="hs-identifier hs-var">MuxError</span></a><span> </span><a href="Network.Mux.Trace.html#MuxShutdown"><span class="hs-identifier hs-var">MuxShutdown</span></a><span> </span><span class="hs-string">&quot;Mux Failed&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a></pre></body></html>